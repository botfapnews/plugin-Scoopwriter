"use strict";angular.module("authoringEnvironmentApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAlohaEditor","mgcrea.ngStrap.button","mgcrea.ngStrap.helpers.dimensions","mgcrea.ngStrap.tooltip","mgcrea.ngStrap.popover","template/modal/backdrop.html","template/modal/window.html","ui.bootstrap.dropdown","ui.bootstrap.modal","ui.select2","gc.toaster","angularFileUpload","ngTagsInput","boxuk.translation"]).config(["$routeProvider","$httpProvider","$buttonProvider",function(a,b,c){a.when("/:language/:article",{templateUrl:"views/main.html",resolve:{articleInstance:["articleLoader",function(a){return a()}]}}).when("/",{templateUrl:"views/error.html",controller:"RedirectToArticleCtrl",controllerAs:"redirectToArticleCtrl"}).when("/:callback*",{templateUrl:"views/oAuthCallback.html",controller:""}).otherwise({redirectTo:"/"}),b.interceptors.push("authInterceptor"),c.defaults.toggleEvent="change"}]).run(["$document",function(a){a.on("dragover drop",function(a){a.preventDefault()})}]);var mutate_event_stack=[{name:"width",handler:function(a){var b={el:a};return $(b.el).data("mutate-width")||$(b.el).data("mutate-width",$(b.el).width()),$(b.el).data("mutate-width")&&$(b.el).width()!==$(b.el).data("mutate-width")?($(b.el).data("mutate-width",$(b.el).width()),!0):!1}},{name:"height",handler:function(a){var b=a;return $(b).data("mutate-height")||$(b).data("mutate-height",$(b).height()),$(b).data("mutate-height")&&$(b).height()!==$(b).data("mutate-height")?($(b).data("mutate-height",$(b).height()),!0):void 0}},{name:"top",handler:function(a){return $(a).data("mutate-top")||$(a).data("mutate-top",$(a).css("top")),$(a).data("mutate-top")&&$(a).css("top")!==$(a).data("mutate-top")?($(a).data("mutate-top",$(a).css("top")),!0):void 0}},{name:"bottom",handler:function(a){return $(a).data("mutate-bottom")||$(a).data("mutate-bottom",$(a).css("bottom")),$(a).data("mutate-bottom")&&$(a).css("bottom")!==$(a).data("mutate-bottom")?($(a).data("mutate-bottom",$(a).css("bottom")),!0):void 0}},{name:"right",handler:function(a){return $(a).data("mutate-right")||$(a).data("mutate-right",$(a).css("right")),$(a).data("mutate-right")&&$(a).css("right")!==$(a).data("mutate-right")?($(a).data("mutate-right",$(a).css("right")),!0):void 0}},{name:"left",handler:function(a){return $(a).data("mutate-left")||$(a).data("mutate-left",$(a).css("left")),$(a).data("mutate-left")&&$(a).css("left")!==$(a).data("mutate-left")?($(a).data("mutate-left",$(a).css("left")),!0):void 0}},{name:"hide",handler:function(a){return $(a).is(":hidden")?!0:void 0}},{name:"show",handler:function(a){return $(a).is(":visible")?!0:void 0}},{name:"scrollHeight",handler:function(a){return $(a).data("prev-scrollHeight")||$(a).data("prev-scrollHeight",$(a)[0].scrollHeight),$(a).data("prev-scrollHeight")&&$(a)[0].scrollHeight!==$(a).data("prev-scrollHeight")?($(a).data("prev-scrollHeight",$(a)[0].scrollHeight),!0):void 0}},{name:"scrollWidth",handler:function(a){return $(a).data("prev-scrollWidth")||$(a).data("prev-scrollWidth",$(a)[0].scrollWidth),$(a).data("prev-scrollWidth")&&$(a)[0].scrollWidth!==$(a).data("prev-scrollWidth")?($(a).data("prev-scrollWidth",$(a)[0].scrollWidth),!0):void 0}},{name:"scrollTop",handler:function(a){return $(a).data("prev-scrollTop")||$(a).data("prev-scrollTop",$(a)[0].scrollTop()),$(a).data("prev-scrollTop")&&$(a)[0].scrollTop()!==$(a).data("prev-scrollTop")?($(a).data("prev-scrollTop",$(a)[0].scrollTop()),!0):void 0}},{name:"scrollLeft",handler:function(a){return $(a).data("prev-scrollLeft")||$(a).data("prev-scrollLeft",$(a)[0].scrollLeft()),$(a).data("prev-scrollLeft")&&$(a)[0].scrollLeft()!==$(a).data("prev-scrollLeft")?($(a).data("prev-scrollLeft",$(a)[0].scrollLeft()),!0):void 0}}];!function(a){function b(){var d=c;"undefined"!==d.event_stack&&d.event_stack.length&&a.each(d.event_stack,function(a,b){c.add_event(b)}),d.event_stack=[],a.each(d.stack,function(b,c){a(c.selector).each(function(a,b){d.events[c.event_name](b)===!0?c.callback&&c.callback(b,c):c.false_callback&&c.false_callback(b,c)})}),setTimeout(b,c.speed)}var c={speed:50,event_stack:mutate_event_stack,stack:[],events:{},add_event:function(a){c.events[a.name]=a.handler},add:function(a,b,d,e){c.stack[c.stack.length]={event_name:a,selector:b,callback:d,false_callback:e}}};b(),a.fn.extend({mutate:function(){var b=!1,d=arguments[1],e=this,f=arguments[2]?arguments[2]:function(){};return"extend"===arguments[0].toLowerCase()?(c.add_event(d),this):(a.each(a.trim(arguments[0]).split(" "),function(a,g){b=g,c.add(b,e,d,f)}),this)}})}(jQuery);var ModalCtrlConstructor=function(a,b,c,d){a.title=c,a.text=d,a.ok=function(){b.close(!0)},a.cancel=function(){b.dismiss(!1)}};ModalCtrlConstructor.$inject=["$scope","$modalInstance","title","text"],angular.module("authoringEnvironmentApp").factory("modalFactory",["$modal",function(a){return{_createConfirmInstance:function(b,c,d){var e=d?"views/modal-confirm-heavy.html":"views/modal-confirm-light.html";return a.open({templateUrl:e,controller:ModalCtrlConstructor,backdrop:"static",keyboard:!1,resolve:{title:function(){return b},text:function(){return c}}})},confirmLight:function(a,b){return this._createConfirmInstance(a,b,!1)},confirmHeavy:function(a,b){return this._createConfirmInstance(a,b,!0)}}}]),function(a){function b(){a.module("authoringEnvironmentApp").config(["$provide",function(a){a.decorator("$httpBackend",angular.mock.e2e.$httpBackendDecorator)}]).run(["$httpBackend",function(a){a.whenGET(/views\/.*/).passThrough();var b={language:"en",fields:{highlight:"0",lede:"<p>BRUSSELS - Italian and Greek candidates nominated for President of the European Council in secret ballot.</p>",body:'<!-- Snippet 12 --><p>It plu plia olda nula, lo ekoo interjekcio aŭ. Iom inkluzive dividostreko sh, subtraho praantaŭhieraŭ bio fo. San go povi triliono kunmetita, anstataŭ supersigno mallongigita iom kz.</p> <!** Image 101 align="left" alt="Daniel Göpfert" sub="Daniel Göpfert" width="90" height="120" > <!-- Snippet 8 align="left" --> <p>Tiel ofon iometo dio at, vir alikvante montrovorto prirespondi re, sis tiam reen frazparto jh. Pov mi pobo infra alternativo, nenio geedzo alimaniere sor um.</p>\r\n<p>Tek in dekoj komplika kernovorto, dekuma disskribado je end. Vendo posttagmezo um esk, ki nedifina personalo, unt. Sen ki tiele aligi resti. Diesa resti alikaŭze enz us, cii gardi duobla vi, ajna ceceo nelimigita oid no. Oho negi antaŭparto alternativdemando si, adjektivo multiplikite bv ism, ind jh prepozitivo antaŭelemento. He ano orda nekutima, mil fi alia patro solstariva.</p>\r\n<p>Tia zepto rolvorteto du. Ar duo frota sepen dikfingro. Des vavo senforte ed. Mano halt\' onklo sur nv, aliu help transigi ian o, amen multe kompreneble ena er. Nul tiuj fora nano jo.</p>\r\n<p>Kuo op negi posta. Kazablanko subpropozicio mal ne. End ad ekoo sori, in sor otek finitivo okulvitroj, egalo latina iom ge. Pra ho filo troa, mf esk apud aliel geedzo, fin duobla fratineto sekstiliono as. Lo devus video kelka mia, sia ed mili fini. Sin nula usono kunmetaĵo ik, cii op tiea post gibi, sob brosi substantiva is.</p>\r\n<p>Jam unun participo sh. Nea mo ioma identiga, mi edzo ekde frikativo dio. Cii milo tohuo iufoje tc, mo tet krom prezoinda tempopunkto, hago dank\' esperantigita ok kie. Iufoje helpverbo ko mis, poa ci dura eĥo komparado. Pli persa deziri ju, falsa ekesti definitive jes aj. Tro iu hodiaŭa infinitivo, e eca malpli kernovorto.</p>\r\n<p>Ke ato armo postpriskribo. Mem al triliono frikativo miriametro, spite vortfarado fo iel. Oj iom ruli okej vatto. Jota tiama tagnokto nu ili. Nei kian spite ki, nenia reciprokeco ajn vo. Hot jena respondeci uj.</p>\r\n<div class="generic-embed"> </div>\r\n<p>Fri go longa senobjekta postmorgaŭ, deci praantaŭhieraŭ ina el, nea ve dato hekto. Ci speco anstataŭi sat, ses mono literaturo ko. Per vi dume falsa fundamenta, amen siatempe kuo id. Pri vi eĥo fontoj frazparto. Kab\'o difina laŭlonge ne aĥ.</p>',printsection:"Sports",printstory:null,iPad_prominent:"0"},authors:[{name:"Test Persona",link:"http://tw-merge.lab.sourcefabric.org/api/author/9"},{name:"Frank N. Stein",link:"http://tw-merge.lab.sourcefabric.org/api/author/13"}],number:"64",title:"European Council candidates set to be named",updated:"2013-12-17T14:31:14+0000",comments:"http://tw-merge.lab.sourcefabric.org/api/articles/64/en/comments",type:"news",published:"2013-11-14T10:49:17+0000",topics:[{id:10,title:"Cruise Night"},{id:10,title:"Crucero nocturno"},{id:11,title:"People In The News"},{id:11,title:"La gente en las noticias"},{id:29,title:"Milan Shows"},{id:29,title:"Muestra Milán"}],slideshow:[{id:5,title:"Berlin Zoo",itemsLink:"http://tw-merge.lab.sourcefabric.org/api/slideshows/5"}],renditions:[{caption:"articlebig",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/600x400%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"sectionthumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/250x167%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"square",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"thumb",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/150x100%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"topfront",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/500x333%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikel",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/555x370%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"artikelnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/639x426%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"blogsidebar",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x150%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbild",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/980x306%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierbildnew",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/990x330%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"dossierteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x131%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"naviteaser",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/120x53%2Ffit%2Fimages%257Ccms-image-000000099.jpg"},{caption:"rubrikenseite",type:"image",link:"tw-merge.lab.sourcefabric.org/images/cache/300x200%2Ffit%2Fimages%257Ccms-image-000000099.jpg"}],webcode:"cup6z",reads:"5"},d={name:"news",fields:[{name:"body",type:"body",fieldWeight:3,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=750",isContentField:1},{name:"highlight",type:"switch",fieldWeight:1,isHidden:0,commentsEnabled:0,isContentField:0},{name:"iPad_prominent",type:"switch",fieldWeight:6,isHidden:0,commentsEnabled:0,isContentField:0},{name:"lede",type:"longtext",fieldWeight:2,isHidden:0,commentsEnabled:0,fieldTypeParam:"editor_size=250",isContentField:0},{name:"printsection",length:0,type:"text",fieldWeight:4,isHidden:0,commentsEnabled:0,isContentField:0},{name:"printstory",length:0,type:"text",fieldWeight:5,isHidden:0,commentsEnabled:0,isContentField:0}]},e=new RegExp(c+"/articles.*");a.whenGET(e).respond(b),a.when("PATCH",e).respond({});var e=new RegExp(c+"/articleTypes.*");a.whenGET(e).respond(d);var f=function(a,b){return{id:a,name:"My "+a+" "+b,template:b,content:{code:'<div class="embed'+a+'">This is so cool, '+b+"</div>"}}},g={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic")},h={5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},i={1:f(1,"Generic"),2:f(2,"Generic"),3:f(3,"Generic"),4:f(4,"Generic"),5:f(5,"Tweet"),6:f(6,"Tweet"),7:f(7,"Tweet"),8:f(8,"Tweet")},e=new RegExp("/api/images[?]page=[0-9]+");a.whenGET(e).respond({items:[{id:1,basename:"Carla-bruni-sarkozy.jpg"},{id:2,basename:"French_election__N_2200069b.jpg"},{id:3,basename:"Strong-turnout-for-French-election.jpg"},{id:4,basename:"sarcozy-presidente-de-francia.jpg"},{id:5,basename:"sarkyDM1910_468x505.jpg"},{id:6,basename:"images-cms-image-003318021.jpg"},{id:7,basename:"images-cms-image-003935520.jpg"},{id:8,basename:"images-cms-image-004021392.jpg"},{id:9,basename:"images-cms-image-004059514.jpg"},{id:10,basename:"images-cms-image-004059556.jpg"}],pagination:{itemsPerPage:10,currentPage:1,itemsCount:149735,nextPageLink:"https://tw-merge.lab.sourcefabric.org/api/images?page=2&items_per_page=10"}});var e=new RegExp("/api/images/[0-9]+");a.whenGET(e).respond({id:1,location:"local",basename:"French_election__N_2200069b.jpg",thumbnailPath:"cms-thumb-000000001.jpg",url:"",description:"image description",width:"150",height:"210",photographer:"",photographerUrl:"",place:""});var e=new RegExp("/api/comments/.*");a.whenGET(e).respond({items:[{id:26822,author:"Inihe Ublinschä",subject:"subject",message:"message",thread_level:0,thread_order:1,status:"approved",created:"2013-11-28T18:10:09+0000",updated:"2013-11-28T18:10:09+0000",recommended:0},{id:26828,author:"More Timat",subject:"ungeeignet..",message:"Mir fiel derselbe Satz auf: «Das Anliegen, die Spekulation mit Grundbesitz einzudämmen ... , sei zwar verständlich, doch die Initiative sei dazu ungeeignet» Ja was gibts denn für geeignete Mittel möchte ich gerne wissen. Enteignung? Verstaatlichung des gesamten Bodens und Verpachtung im Baurecht für 99 Jahre? Vorschläge willkommen!",thread_level:0,thread_order:2,status:"approved",created:"2013-11-28T21:30:43+0000",updated:"2013-11-28T21:30:43+0000",recommended:1}]});var j=g,k=(f(1,"Generic"),{id:1,name:"Generic",template:"%code%"});a.whenGET(/\/api\/article\/64\/1\/snippets\/[\d]/).respond(function(a,b,c){return console.log(b.split("/")),[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/api\/article\/64\/1\/snippets/).respond(j),a.whenGET(/\/api\/snippets\/generic\/[\d]/).respond(function(a,b,c){return[200,f(b.split("/")[4],"generic")]}),a.whenGET(/\/api\/snippets\/tweet\/[\d]/).respond(function(a,b,c){return[200,f(b.split("/")[4],"tweet")]}),a.whenGET(/\/api\/snippets\/generic/).respond(g),a.whenGET(/\/api\/snippets\/tweet/).respond(h),a.whenGET(/\/api\/snippets/).respond(i),a.whenGET(/\/api\/snippetTemplate\/[\d]/).respond(k)}])}if(document.URL.match(/nobackend$/)){console.log("=== STUBBED BACKEND ===");var c="http://newscoop.aes.sourcefabric.net/api";b()}}(angular),angular.module("authoringEnvironmentApp").filter("availableRoles",[function(){return function(a,b,c){var d=[];return b?(a.forEach(function(a){var e=!1;c.forEach(function(c){return c!==b&&c.id===b.id&&c.articleRole.id===a.id?void(e=!0):void 0}),e||d.push(a)}),d):a}}]),angular.module("authoringEnvironmentApp").filter("allowedWfStatuses",["Article",function(a){return function(b,c,d){var e=[];return b.forEach(function(b){var f=!0;b.value===a.wfStatus.PUBLISHED_W_ISS&&(f=c!==a.wfStatus.PUBLISHED&&d!==a.issueWfStatus.PUBLISHED),f&&e.push(b)}),e}}]),angular.module("authoringEnvironmentApp").controller("MainCtrl",["$scope","$window","mode","userAuth","toaster",function(a,b,c,d,e){if(d.isAuthenticated())a.auth=!0;else{a.auth=!1;var f=d.obtainToken();f.then(function(b){a.auth=!0})["catch"](function(){var b=d.newTokenByLoginModal();b.then(function(b){a.auth=!0})["catch"](function(){e.add({type:"sf-error",message:"Could not get access token. Check AES_SETTINGS.auth config."})})})}a.$on("$viewContentLoaded",function(){jQuery("#cs-specific").prependTo(".main-background-container")}),a.mode=c}]),function(){function a(a,b){angular.element(b).on("storage",function(){b.sessionStorage.getItem(AES_SETTINGS.auth.tokenKeyName)&&a.close()})}a.$inject=["$modalInstance","$window"],angular.module("authoringEnvironmentApp").service("userAuth",["$http","$modal","$q","$window","toaster",function(b,c,d,e,f){var g=this;g.token=function(){return e.sessionStorage.getItem(AES_SETTINGS.auth.tokenKeyName)},g.isAuthenticated=function(){return!!e.sessionStorage.getItem(AES_SETTINGS.auth.tokenKeyName)},g.setToken=function(a){e.sessionStorage.setItem(AES_SETTINGS.auth.tokenKeyName,a)},g.obtainToken=function(){var a=d.defer();return b.get(Routing.generate("newscoop_gimme_users_getuseraccesstoken",{clientId:AES_SETTINGS.auth.client_id},!0),{IS_RETRY:!0,IS_AUTHORIZATION_HEADER:!0}).success(function(b){g.setToken(b.access_token),a.resolve(b)}).error(function(b){a.reject(b)}),a.promise},g.newTokenByLoginModal=function(){var b,e=d.defer();return b=c.open({templateUrl:"views/modal-login.html",controller:a,controllerAs:"ctrl",windowClass:"modalLogin",backdrop:"static"}),b.result.then(function(){f.add({type:"sf-info",message:"Successfully refreshed authentication token."}),e.resolve()})["catch"](function(a){f.add({type:"sf-error",message:"Failed to refresh authentication token."}),e.reject(a)}),e.promise}}])}(),angular.module("authoringEnvironmentApp").controller("RedirectToArticleCtrl",["$location","toaster",function(a,b){var c=this;if(c.hasError=!1,c.articleNumber=null,AES_SETTINGS?AES_SETTINGS.articleInfo&&AES_SETTINGS.articleInfo.articleNumber?c.articleNumber=AES_SETTINGS.articleInfo.articleNumber:(b.add({type:"sf-error",message:"You are missing AES_SETTINGS.artcleInfo config."}),c.hasErrors=!0):(b.add({type:"sf-error",message:"You are missing AES_SETTINGS config."}),c.hasErrors=!0),c.articleNumber){var d=["/",AES_SETTINGS.articleInfo.language,"/",AES_SETTINGS.articleInfo.articleNumber].join("");a.path(d)}}]),angular.module("authoringEnvironmentApp").factory("articleLoader",["$route","$q","Article","article","pageHelper",function(a,b,c,d,e){return function(){var f=b.defer(),g=a.current.params;return c.getById(g.article,g.language).then(function(a){d.articleInstance=a,e.populateHeaderTitle(),f.resolve(a)})["catch"](function(a){f.reject(a)}),f.promise}}]),angular.module("authoringEnvironmentApp").factory("Topic",["$http","$q","$timeout","dateFactory","pageTracker","transform",function(a,b,c,d,e,f){var g=250,h=null,i=0,j=function(){};return j.createFromApiData=function(a){var b=new j;return b.id=parseInt(a.id),b.title=a.title,b.path=a.path,b.parentId=parseInt(a.parent),b.level=parseInt(a.level),b.order=parseInt(a.order),b.text=b.title,b},j.getAll=function(c){var d,e=[],f=b.defer();return e.$promise=f.promise,d=Routing.generate("newscoop_gimme_topics_gettopics",{language:c,items_per_page:9999},!0),a.get(d).success(function(a){a.items.forEach(function(a){a=j.createFromApiData(a),e.push(a)}),f.resolve()}).error(function(a){f.reject(a)}),e},j.getAllByArticle=function(c,d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_topics_getarticlestopics",{number:c,language:d},!0),a.get(e).success(function(a){a.items.forEach(function(a){a=j.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},j.liveSearchQuery=function(b,f){var k,l=b.page>1,m=d.makeInstance();if(!f){if(!l)return i=m,void c(function(){j.liveSearchQuery(b,!0)},g);if(angular.equals(b.context,h))return;h=b.context}!l&&g>m-i||(k=Routing.generate("newscoop_gimme_topics_searchtopics",{items_per_page:10,page:b.page,query:b.term},!0),a.get(k).success(function(a){var c,d=[];a.items.forEach(function(a){c=j.createFromApiData(a),d.push(c)}),b.callback({results:d,more:!e.isLastPage(a.pagination),context:a.pagination})}))},j.create=function(c,d,e){var g,h=b.defer(),i={topic:{}};return i.topic.title=c,"undefined"!=typeof d&&(i.topic.parent=d),i.topic.locale=e,g=Routing.generate("newscoop_gimme_topics_createtopic",{},!0),a.post(g,i,{transformRequest:f.formEncode}).then(function(b){var c=b.headers("x-location");return a.get(c)},b.reject).then(function(a){var b=j.createFromApiData(a.data);h.resolve(b)},function(){h.reject()}),h.promise},j.addToArticle=function(c,d,e){var f=b.defer(),g=[];if(e.length<1)throw new Error("Topics list is empty.");return e.forEach(function(a){g.push("<"+Routing.generate("newscoop_gimme_topics_gettopicbyid",{id:a.id},!1)+'; rel="topic">')}),g=g.join(),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:g}}).success(function(){f.resolve(e)}).error(function(a){f.reject(a)}),f.promise},j.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e=["<",Routing.generate("newscoop_gimme_topics_gettopicbyid",{id:f.id},!1),'; rel="topic">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},j}]),angular.module("authoringEnvironmentApp").controller("SfPanesCtrl",["$scope","$filter","panes",function(a,b,c){a.panes=c.query(),a.tabpaneIsOpen=function(c){return b("filter")(a.panes,{position:c,selected:!0,visible:!0}).length>0},a.flipVisible=function(a){c.visible(a),a.active=!0}}]),angular.module("authoringEnvironmentApp").controller("PaneAuthorsCtrl",["$scope","$q","article","Author","modalFactory","toaster","TranslationService",function(a,b,c,d,e,f,g){var h=c.articleInstance,i=this;i.setRoleChangeWatch=function(b){var c=a.$watch(function(){return b.articleRole},function(a,c){a!==c&&i.authorRoleChanged(a,c,b)},!0);b.stopRoleChangeWatch=c},i.authorRoleChanged=function(a,b,c){c.updatingRole=!0,c.updateRole({number:h.articleId,language:h.language,oldRoleId:b.id,newRoleId:c.articleRole.id}).then(function(){f.add({type:"sf-info",message:g.trans("aes.msgs.authors.change.success")})},function(){c.stopRoleChangeWatch(),c.articleRole=b,i.setRoleChangeWatch(c),f.add({type:"sf-error",message:g.trans("aes.msgs.authors.change.error")})})["finally"](function(){c.updatingRole=!1})},a.authorRoles=d.getRoleList(),a.authors=[],a.newAuthor=null,a.newAuthorRoleId=null,a.addingNewAuthor=!1,a.showAddAuthor=!0,a.select2Options={minimumInputLength:3,query:d.liveSearchQuery},a.clearNewAuthorForm=function(){a.newAuthor=null,a.newAuthorRoleId=null},a.addAuthorToArticle=function(){var b=angular.copy(a.newAuthor),c=a.newAuthorRoleId;a.addingNewAuthor=!0,b.addToArticle(h.articleId,h.language,c).then(function(){a.authors.push(b),i.setRoleChangeWatch(b),f.add({type:"sf-info",message:g.trans("aes.msgs.authors.add.success")})},function(){f.add({type:"sf-error",message:g.trans("aes.msgs.authors.add.error")})})["finally"](function(){a.addingNewAuthor=!1})},a.confirmRemoveAuthor=function(c){var d,i,j;i=g.trans("aes.msgs.authors.remove.popupHead"),j=g.trans("aes.msgs.authors.remove.popup"),d=e.confirmLight(i,j),d.result.then(function(b){return c.removeFromArticle(h.articleId,h.language,c.articleRole.id).then(function(){_.remove(a.authors,function(a){return a===c}),f.add({type:"sf-info",message:g.trans("aes.msgs.authors.remove.success")})},function(){f.add({type:"sf-error",message:g.trans("aes.msgs.authors.remove.error")})})},b.reject)},a.orderChanged=function(){d.setOrderOnArticle(h.articleId,h.language,a.authors)},a.authors=d.getAllByArticle(h.articleId,h.language),a.authors.$promise.then(function(){a.authors.forEach(function(a){i.setRoleChangeWatch(a)})})}]),angular.module("authoringEnvironmentApp").controller("PaneInfoCtrl",["article",function(a){var b=this;b.article=a.articleInstance}]),angular.module("authoringEnvironmentApp").controller("PaneTopicsCtrl",["$q","$scope","article","modalFactory","Topic","toaster","TranslationService",function(a,b,c,d,e,f,g){var h=c.articleInstance,i=[],j=!1;b.selectedTopics=[],b.assigningTopics=!1,b.select2Options={minimumInputLength:3,query:e.liveSearchQuery},b.addingNewTopic=!1,b.newTopic={title:"",parentTopic:null},b.assignedTopics=e.getAllByArticle(h.articleId,h.language),b.addNewTopicToArticle=function(c){var d;b.addingNewTopic=!0,e.create(c.title,c.parentTopic?c.parentTopic.id:void 0,h.language).then(function(a){return d=a,f.add({type:"sf-info",message:g.trans("aes.msgs.topics.add.success")}),e.addToArticle(h.articleId,h.language,[d])},function(c){return f.add({type:"sf-error",message:g.trans("aes.msgs.topics.add.error")}),409===c.status&&b.addTopic.topicTitle.$setValidity("duplicate",!1),a.reject(c)}).then(function(){var a=_.findIndex(b.assignedTopics,{id:d.parentId});a>-1?b.assignedTopics.splice(a+1,0,d):b.assignedTopics.push(d),b.clearNewTopicForm()},a.reject)["finally"](function(){b.addingNewTopic=!1})},b.clearNewTopicForm=function(){b.newTopic.title="",b.newTopic.parentTopic=null,b.addTopic.topicTitle.$setValidity("duplicate",!0)},b.clearSelectedTopics=function(){for(;b.selectedTopics.length>0;)b.selectedTopics.pop()},b.findTopics=function(c){var d,f=a.defer(),g={};return b.selectedTopics.forEach(function(a){g[a.id]=!0}),b.assignedTopics.forEach(function(a){g[a.id]=!0}),j||(i=e.getAll(h.language)),i.$promise.then(function(){j=!0,c=c.toLowerCase(),d=_.filter(i,function(a){return!(a.id in g)&&a.title.toLowerCase().indexOf(c)>=0}),f.resolve(d)}),f.promise},b.assignSelectedToArticle=function(){b.assigningTopics=!0,e.addToArticle(h.articleId,h.language,b.selectedTopics).then(function(a){a.forEach(function(a){b.assignedTopics.push(a)}),b.clearSelectedTopics(),f.add({type:"sf-info",message:g.trans("aes.msgs.topics.assign.success")})},function(){f.add({type:"sf-error",message:g.trans("aes.msgs.topics.assign.error")})})["finally"](function(){b.assigningTopics=!1})},b.confirmUnassignTopic=function(c){var e,i,j;i=g.trans("aes.msgs.topics.unassign.popupHead"),j=g.trans("aes.msgs.topics.unassign.popup"),e=d.confirmLight(i,j),e.result.then(function(){return c.removeFromArticle(h.articleId,h.language).then(function(){_.remove(b.assignedTopics,{id:c.id}),f.add({type:"sf-info",message:g.trans("aes.msgs.topics.unassign.success")})},function(){f.add({type:"sf-error",message:g.trans("aes.msgs.topics.unassign.error")})})},a.reject)}}]),angular.module("authoringEnvironmentApp").controller("PaneSwitchesCtrl",["$q","article","ArticleType","toaster","TranslationService",function(a,b,c,d,e){var f=this;f.article=b.articleInstance,f.modified=!1,f.saveInProgress=!1,AES_SETTINGS.showSwitches?f.switches=[{name:"show_on_front_page",text:"Show on Front Page"},{name:"show_on_section_page",text:"Show on Section Page"}]:f.switches=[],c.getByName(f.article.type).then(function(a){a.fields.forEach(function(a){a.isHidden||"switch"!==a.type||(f.switches.push({name:a.name,text:a.phrase||a.name}),f.article.fields[a.name]=!!parseInt(f.article.fields[a.name]))}),["show_on_front_page","show_on_section_page"].forEach(function(a){f.article.fields[a]=!!parseInt(f.article.fields[a])})}),f.valueChanged=function(){f.modified=!0},f.save=function(){var a=_.map(f.switches,"name");f.saveInProgress=!0,f.article.saveSwitches(a).then(function(){d.add({type:"sf-info",message:e.trans("aes.msgs.switches.success")})},function(){d.add({type:"sf-error",message:e.trans("aes.msgs.switches.error")})})["finally"](function(){f.modified=!1,f.saveInProgress=!1})}}]),angular.module("authoringEnvironmentApp").controller("FeedbackForm",["modal","feedback","toaster","TranslationService",function(a,b,c,d){var e=this;e.feedback={},e.processing=!1,e.messageMaxLength=1e3,e.feedbackModal=function(){a.show({title:d.trans("aes.msgs.feedback.modalHead"),templateUrl:"views/feedback.html",windowClass:"small"})},e.cancel=function(b){b.preventDefault(),b.stopPropagation(),e.feedback={},a.hide()},e.submit=function(){e.processing=!0,b.submit(e.feedback).then(function(){c.add({type:"sf-info",message:d.trans("aes.msgs.feedback.success")}),e.feedback={},a.hide()},function(){c.add({type:"sf-error",message:d.trans("aes.msgs.feedback.error")})})["finally"](function(){e.processing=!1})}}]),angular.module("authoringEnvironmentApp").service("feedback",["$http","$q","transform",function(a,b,c){var d=this;d.submit=function(d){var e,f=b.defer();return e={feedback:d},a.post(Routing.generate("aes_send_feedback",{},!0),e,{transformRequest:c.formEncode}).success(function(a){f.resolve(a)}).error(function(a){f.reject(a)}),f.promise}}]),angular.module("authoringEnvironmentApp").factory("panes",["$filter",function(a){function b(a){var b="";return angular.forEach(a,function(a,c){switch(a){case"small":b+="shrink-"+c+" ";break;case"big":b+="shrink-"+c+"-more "}}),b}var c=[{name:"Info",id:"info",icon:"info",template:"views/pane-info.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Authors",id:"authors",icon:"authors",template:"views/pane-authors.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Related Articles",id:"related-articles-panel",icon:"relatedarticles",template:"views/pane-related-articles.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Switches",id:"switches",icon:"switches",template:"views/pane-switches.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Topics",id:"topics",icon:"topics",template:"views/pane-topics.html",position:"right",size:"small",visible:!1,active:!1,selected:!0},{name:"Images",id:"images",icon:"media",template:"views/pane-draggable.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Slideshows",id:"slideshows",icon:"slideshows",template:"views/pane-slideshows.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Snippets",id:"snippets",icon:"embeds",template:"views/pane-embed.html",position:"left",size:"small",visible:!1,active:!1,selected:!0},{name:"Comments",id:"comments",icon:"comments",template:"views/pane-comments.html",position:"left",size:"big",visible:!1,active:!1,selected:!0},{name:"Editorial Comments",id:"editorial-comments",icon:"editorial_comments",template:"views/pane-editorial-comments.html",position:"right",size:"big",visible:!1,active:!0,selected:!0}];return c.layout={right:null,left:null},c.articleClass="",{query:function(){return c},visible:function(a){c.forEach(function(b){b===a?a.visible=!a.visible:b.visible=!1}),c.layout=this.layout(c),c.articleClass=b(c.layout)},layout:function(a){var b={left:null,right:null};return a.forEach(function(a){a.visible&&(b[a.position]=a.size)}),b}}}]),angular.module("authoringEnvironmentApp").controller("PanesConfigCtrl",["$scope","panes",function(a,b){a.panes=b.query(),a.flipPosition=function(a){a.position="left"===a.position?"right":"left"}}]),angular.module("authoringEnvironmentApp").controller("ArticleCtrl",["$window","$q","$scope","$rootScope","article","Article","ArticleType","panes","mode","platform","toaster",function(a,b,c,d,e,f,g,h,i,j,k){var l=this;/msie/i.test(a.navigator.userAgent)&&k.add({type:"sf-error",message:"Article Edit Screen does not fully support the Internet Explorer browser.  Some features may not function as expected."}),l.fieldStatsText=function(a){var b,d,e;return e="title"===a?c.article.title:c.article.fields[a],d=f.textStats(e),b=[d.chars," Character",1!==d.chars?"s":""," / ",d.words," Word",1!==d.words?"s":""].join("")},c.mode=i,c.articleService=e,c.article=e.articleInstance,c.panes=h.query(),c.platform=j,c.placeholder=AES_SETTINGS.placeholder,d.$on("texteditor-content-changed",function(a,b,d){var e,f,g={keypress:!0,paste:!0,idle:!0,undo:!0,redo:!0};d.triggerType in g&&(e=d.editable.originalObj.data("field-name"),f=l.fieldStatsText(e),c.$evalAsync(function(){var a=_(c.editableFields).find({name:e});a.statsText=f}))}),g.getByName(c.article.type).then(function(a){var b,d,e,f=[],g=[];a.fields.forEach(function(a){var b;a.isHidden||(a.showInEditor&&"switch"!==a.type?(b=c.article.fields[a.name],a.statsText=l.fieldStatsText(a.name),f.push(a)):"switch"!==a.type&&"body"!==a.type&&g.push(a))}),b=AES_SETTINGS.articleTypeFields[a.name],d={name:b.title.name,phrase:b.title.displayName,statsText:l.fieldStatsText("title")},e=b.title.order-1,c.article.title||(c.article.title=AES_SETTINGS.placeholder),f=_.sortBy(f,"fieldWeight"),f.splice(e,0,d),c.editableFields=f,c.nonContentFields=_.sortBy(g,"fieldWeight")}),c.save=function(){c.article.save().then(function(){c.articleService.modified=!1})},c.nonContentFieldChanged=function(){e.modified=!0}}]),angular.module("authoringEnvironmentApp").controller("ArticleActionsCtrl",["$rootScope","$scope","$window","article","Article","mode","toaster","TranslationService","pageHelper","articleLoader",function(a,b,c,d,e,f,g,h,i,j){var k;b.mode=f,b.articleService=d,
b.article=d.articleInstance,b.Article=e,b.workflowStatuses=[{value:e.wfStatus.NEW,text:"New"},{value:e.wfStatus.SUBMITTED,text:"Submitted"},{value:e.wfStatus.PUBLISHED,text:"Published"},{value:e.wfStatus.PUBLISHED_W_ISS,text:"Published with issue"}],b.changingWfStatus=!1,a.$on("texteditor-content-changed",function(a,c,d){var e={keypress:!0,paste:!0,idle:!0,undo:!0,redo:!0};(d.triggerType in e||!d.triggerType)&&b.setModified(!0)}),k=_.find(b.workflowStatuses,{value:b.article.status}),b.wfStatus=k,b.setWorkflowStatus=function(a){b.changingWfStatus=!0,b.article.setWorkflowStatus(a).then(function(){var c=_.find(b.workflowStatuses,{value:a});b.wfStatus=c,void 0===d.articleInstance.url&&j().then()})["finally"](function(){b.changingWfStatus=!1})},b.close=function(){var a=[AES_SETTINGS.API.rootURI,"/","admin/articles/index.php?","f_publication_id=",b.article.publication.id,"&f_issue_number=",b.article.issue.number,"&f_language_id=",b.article.languageData.id,"&f_section_number=",b.article.section.number].join("");b.article.releaseLock().then(function(){c.location.href=a})["catch"](function(){g.add({type:"sf-error",message:"Unlocking the article failed."})})},b.save=function(){b.article.save().then(function(){b.setModified(!1),i.populateHeaderTitle(),g.add({type:"sf-info",message:h.trans("aes.alerts.saved")})},function(){g.add({type:"sf-error",message:h.trans("aes.alerts.save.error")})})},b.setModified=function(a){b.articleService.modified=a}}]),function(){function a(a,b,c){var d,e=this;d=[AES_SETTINGS.API.rootURI,"/admin/articles/preview.php?","f_publication_id=",c.publicationId,"&f_issue_number=",c.issueId,"&f_section_number=",c.sectionId,"&f_article_number=",c.articleId,"&f_language_id=",c.languageId,"&f_language_selected=",c.languageId].join(""),e.url=b.trustAsResourceUrl(d),e.close=function(){a.close()}}a.$inject=["$modalInstance","$sce","articleInfo"],angular.module("authoringEnvironmentApp").controller("ArticlePreviewCtrl",["$modal","$window","article",function(b,c,d){var e=this;e.article=d.articleInstance,e.openLiveView=function(){c.open(d.articleInstance.url)},e.openPreview=function(){b.open({templateUrl:"views/modal-article-preview.html",controller:a,controllerAs:"modalPreviewCtrl",windowClass:"modalPreview",resolve:{articleInfo:function(){return{articleId:e.article.articleId,languageId:e.article.languageData.id,publicationId:e.article.publication.id,issueId:e.article.issue.number,sectionId:e.article.section.number}}}})}}])}(),function(){function a(a,b,c){var d,e=this;d=[AES_SETTINGS.API.rootURI,"/admin/image/article","/article_number/",c.articleId,"/language_id/",c.languageId].join(""),e.url=b.trustAsResourceUrl(d),e.close=function(){a.close()}}a.$inject=["$modalInstance","$sce","articleInfo"],angular.module("authoringEnvironmentApp").controller("RenditionsEditorCtrl",["$modal","article",function(b,c){var d=c.articleInstance,e=this;e.openRenditionsEditor=function(){b.open({templateUrl:"views/modal-renditions-editor.html",controller:a,controllerAs:"modalRenditionsCtrl",windowClass:"renditionsModal",resolve:{articleInfo:function(){return{articleId:d.articleId,languageId:d.languageData.id}}}})}}])}(),function(){function a(a,b,c,d){var e,f=this;switch(c.action){case"edit":e=[AES_SETTINGS.API.rootURI,"/admin/slideshow/edit","/article_number/",c.articleId,"/slideshow/",c.slideshowId].join("");break;case"create":e=[AES_SETTINGS.API.rootURI,"/admin/slideshow/create","/article_number/",c.articleId].join("");break;case"attach":e=[AES_SETTINGS.API.rootURI,"/admin/slideshow/attach","/article_number/",c.articleId].join("");break;default:e=""}f.url=b.trustAsResourceUrl(e),f.close=function(){d.$broadcast("close-slideshow-modal"),a.close()}}a.$inject=["$modalInstance","$sce","info","$rootScope"],angular.module("authoringEnvironmentApp").controller("SlideshowsEditorCtrl",["$modal","article",function(b,c){var d=c.articleInstance,e=this;e.openSlideshowsEditor=function(c,e){b.open({templateUrl:"views/modal-slideshows-editor.html",controller:a,controllerAs:"modalSlideshowsEditorCtrl",windowClass:"renditionsModal",resolve:{info:function(){return{articleId:d.articleId,action:c,slideshowId:e}}}})}}])}(),angular.module("authoringEnvironmentApp").factory("Slideshow",["$http","$q",function(a,b){var c=function(){};return c.createFromApiData=function(a){var b=new c;return b.id=parseInt(a.id),b.title=a.title,b.itemsCount=parseInt(a.itemsCount),void 0!==a.items&&a.items.length>0&&(b.cover=a.items[0].thumbnail,b.type=a.items[0].type,"video"===b.type&&(b.cover=a.items[0].link)),b},c.getAllByArticle=function(d,e){var f,g=[],h=b.defer();return g.$promise=h.promise,f=Routing.generate("newscoop_gimme_articles_slideshows",{number:d,language:e},!0),a.get(f).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),g.push(a)}),h.resolve()}).error(function(a){h.reject(a)}),g},c.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e=["<",Routing.generate("newscoop_gimme_slideshows_getslideshowitems",{id:f.id},!1),'; rel="slideshow">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},c}]),angular.module("authoringEnvironmentApp").filter("youtubeThumbnail",[function(){var a=new RegExp(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);return function(b){var c=b.match(a);return c?"//img.youtube.com/vi/"+c[2]+"/default.jpg":void 0}}]),angular.module("authoringEnvironmentApp").controller("PaneSlideshowsCtrl",["$q","article","modalFactory","Slideshow","toaster","$scope","TranslationService",function(a,b,c,d,e,f,g){var h=b.articleInstance,i=this;i.assignedSlideshows=d.getAllByArticle(h.articleId,h.language),f.$on("close-slideshow-modal",function(a){i.assignedSlideshows=d.getAllByArticle(h.articleId,h.language)}),i.confirmUnassignSlideshow=function(b){var d,f,j;f=g.trans("aes.msgs.slideshows.unassign.popupHead"),j=g.trans("aes.msgs.slideshows.unassign.popup"),d=c.confirmLight(f,j),d.result.then(function(){return b.removeFromArticle(h.articleId,h.language).then(function(){_.remove(i.assignedSlideshows,{id:b.id}),e.add({type:"sf-info",message:g.trans("aes.msgs.slideshows.unassign.success")})},function(){e.add({type:"sf-error",message:g.trans("aes.msgs.slideshows.unassign.error")})})},a.reject)}}]),angular.module("authoringEnvironmentApp").factory("AlohaFormattingFactory",["$rootScope",function(a){a.$on("texteditor-selection-changed",function(){angular.forEach(b,function(a,b){var c=Aloha.queryCommandState(a);jQuery(".editoricon-"+a.toLowerCase()).parent().toggleClass("active",c)})});var b=[],c=["Insertorderedlist","Insertunorderedlist"];return{get:function(){return b},add:function(a){-1===c.indexOf(a)&&b.push(a)},remove:function(a){var c=b.indexOf(a);c>-1&&b.splice(c,1)},query:function(a){return-1===c.indexOf(a)?Aloha.queryCommandState(a):!1}}}]),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatGeneric",["AlohaFormattingFactory",function(a){var b=['<button class="btn btn-default btn-sm action strong" ','    rel="tooltip" title="{{buttonName}}">','    <i class="editoricon-{{alohaElement|lowercase}} ','              fa fa-{{alohaElement|lowercase}}"></i>',"</button>"].join("");return{template:b,restrict:"A",replace:!0,scope:{alohaElement:"@alohaElement",buttonName:"@buttonName"},link:function(b,c,d){var e,f;a.add(b.alohaElement),f=Aloha.queryCommandSupported(b.alohaElement),e=Aloha.queryCommandEnabled(b.alohaElement),"undefined"==typeof e&&(e=!0),c.attr("disabled",!f||!e),c.bind("click",function(){Aloha.execCommand(b.alohaElement,!1,""),c.toggleClass("active",a.query(b.alohaElement))})}}}]),function(){function a(a,b,c,d){a.linkData={},["url","text","title"].forEach(function(b){a.linkData[b]=c[b]}),a.linkData.openNewWindow=!!c.openNewWindow,a.addingNew=d,a.ok=function(){b.close(a.linkData)},a.cancel=function(){b.dismiss(!1)}}function b(b,c,d,e){function f(f,g,h){function i(){var a,b,c,e,f,g,h=d.getSelection(),i=!0;a=$(h.anchorNode).parents(".aloha-editable"),b=$(h.anchorNode).parents(".aloha-block"),e=a.length>0||b.length>0,"Range"===h.type&&(c=h.getRangeAt(0),i=c.commonAncestorContainer instanceof HTMLDivElement?!1:!0),f=!h.isCollapsed,r.attr("disabled",!(o&&n&&i&&e&&(t||f))),s.attr("disabled",!(q&&p&&e&&t)),g=t?"Edit Link":"Add Link",r.attr("title",g)}function j(b,d){var e=c.open({templateUrl:"views/modal-edit-link.html",controller:a,scope:f,backdrop:"static",keyboard:!1,resolve:{linkData:function(){return b},addingNew:function(){return d}}});return e.result}function k(){var a,b;a=d.getSelection(),b=$(a.anchorNode).closest("a"),b.length>0&&b.replaceWith(b.html()),t=!1}function l(a){var b,c;c=d.getSelection(),c.removeAllRanges(),b=new Range,b.setStart(a[0],0),b.setEnd(a[0],a[0].childNodes.length),c.addRange(b)}var m,n,o,p,q,r,s,t=!1;m=g.children(),r=$(m[0]),s=$(m[1]),m.unwrap(),o=Aloha.queryCommandSupported("createLink"),n=Aloha.queryCommandEnabled("createLink"),"undefined"==typeof n&&(n=!0),q=Aloha.queryCommandSupported("unlink"),p=Aloha.queryCommandEnabled("unlink"),"undefined"==typeof p&&(p=!0),b.$on("texteditor-selection-changed",function(){t=!!Aloha.queryCommandValue("createLink"),i()}),r.click(function(){var a,b,c,f={},g=d.getSelection();c=$(g.anchorNode).closest("a"),a=c.length<=0,a?b=g.getRangeAt(0):(f.url=c.attr("href"),f.title=c.attr("title"),f.openNewWindow="_blank"===c.attr("target"),l(c)),f.text=g.toString(),j(f,a).then(function(d){if(a){c=jQuery("<a/>");try{b.surroundContents(c[0]),c.find("a").each(function(a,b){var c=$(b);c.replaceWith(c.html())})}catch(f){e.add({type:"sf-error",message:"Invalid selection.  Please only select text."})}}c.attr("href",d.url),c.attr("title",d.title),d.openNewWindow?c.attr("target","_blank"):c.removeAttr("target"),l(c),t=!0})["finally"](function(){i()})}),s.click(function(){t&&(k(),i())}),i()}var g=["<div>",'  <button class="btn btn-default btn-sm" title="Add Link">','      <i class="fa fa-link"></i>',"  </button>",'  <button class="btn btn-default btn-sm" title="Remove Link">','      <i class="fa fa-unlink"></i>',"  </button>","</div>"].join("");return{template:g,restrict:"E",replace:!0,scope:{},link:f}}a.$inject=["$scope","$modalInstance","linkData","addingNew"],angular.module("authoringEnvironmentApp").directive("sfAlohaFormatLink",["$rootScope","$modal","$window","toaster",b])}(),angular.module("authoringEnvironmentApp").directive("sfAlohaFormatStyle",function(){return{template:'<button class="dropdown-button">{{styleName}}</button>',restrict:"A",replace:!0,scope:{styleElement:"@styleElement",styleName:"@styleName"},link:function(a,b,c){var d=Aloha.queryCommandSupported("formatBlock")&&Aloha.queryCommandEnabled("formatBlock");b.toggleClass("disabled",d),b.bind("click",function(){for(var b=$(Aloha.Selection.rangeObject.limitObject)[0].id,c=0;c<Aloha.editables.length;c++){var d=Aloha.editables[c];b===d.obj[0].id&&(Aloha.activeEditable=Aloha.editables[c])}"blockquote"===a.styleElement?Aloha.addBlockQuote():(Aloha.blockquoteFound&&Aloha.removeBlockQuote(),Aloha.execCommand("formatBlock",!1,a.styleElement),Aloha.trigger("aloha-smart-content-changed",{editable:Aloha.activeEditable}))})}}}),angular.module("authoringEnvironmentApp").directive("sfIframeLogin",[function(){return{template:"<iframe></iframe>",replace:!0,restrict:"E",link:function(a,b,c){var d;d=[AES_SETTINGS.auth.server,"?client_id=",AES_SETTINGS.auth.client_id,"&redirect_uri=",AES_SETTINGS.auth.redirect_uri,"&response_type=token"].join(""),b.attr("src",d),b.attr("width",c.width||570),b.attr("height",c.height||510)}}}]),angular.module("authoringEnvironmentApp").controller("ToolbarCtrl",["$scope","$rootScope","$filter","$timeout",function(a,b,c,d){a.stylers=[{element:"p",name:"Normal Text"},{element:"h1",name:"Heading 1"},{element:"h2",name:"Heading 2"},{element:"h3",name:"Heading 3"},{element:"h4",name:"Heading 4"},{element:"h5",name:"Heading 5"},{element:"blockquote",name:"Blockquote"},{element:"pre",name:"Preformatted"}],a.active=c("filter")(a.stylers,{element:"p"},!0)[0].name,a.updateScope=function(){var b,e=Aloha.queryCommandValue("formatBlock");e.toString().length>0?(b=c("filter")(a.stylers,{element:e},!0),b.length>0&&d(function(){a.active=b[0].name})):d(function(){Aloha.blockquoteFound?a.active="Blockquote":a.active="Normal Text"},30)},b.$on("texteditor-selection-changed",function(){a.updateScope()}),b.$on("texteditor-command-executed",function(){a.updateScope()})}]),angular.module("authoringEnvironmentApp").service("article",[function(){}]),angular.module("authoringEnvironmentApp").factory("Article",["$http","$q","transform","ArticleType",function(a,b,c,d){function e(a){var b="<--";b+="\\s",b+="Snippet",b+="\\s",b+="([\\d]+)",b+="(",b+="(",b+="[\\s]+",b+="(align",b+="|\\w+)",b+="\\s*",b+="=",b+="\\s*",b+="(",b+='"[^"]*"',b+="|[^\\s]*",b+=")",b+=")*",b+=")",b+="[\\s]*",b+="-->";var c=new RegExp(b,"ig"),d=a.replace(c,function(a,b){var c='<div class="snippet aloha-snippet-block" data-id="';return c+=parseInt(b),c+='"></div>'});return d}function f(a){var b="<!";b+="\\*\\*",b+="[\\s]*",b+="Image",b+="[\\s]+",b+="([\\d]+)",b+="(",b+="(",b+="[\\s]+",b+="(align|alt|sub",b+="|width|height|ratio",b+="|\\w+)",b+="\\s*",b+="=",b+="\\s*",b+="(",b+='"[^"]*"',b+="|[^\\s]*",b+=")",b+=")*",b+=")",b+="[\\s]*",b+=">";var c=new RegExp(b,"ig"),d=a.replace(c,function(a,b,c){var d='<div class="image aloha-image-block" dropped-image data-articleimageid="'+b+'"',e=document.createElement("div");e.innerHTML="<div "+c+"></div>";for(var f=e.childNodes[0].attributes,g=0;g<f.length;g++)d+=" data-"+f[g].name+'="'+f[g].value+'"';return d+="></div>"});return d}function g(a){var b,c,d;return null===a?a:(d={snippet:"--",image:"**"},b=$("<div/>").html(a),["image","snippet"].forEach(function(a){c=[],c.push(b.contents().filter("div."+a)),c.push(b.contents().find("div").filter("div."+a)),c.forEach(function(b){b.replaceWith(function(){var b,c,e=$(this);return c=["<",d[a]," ",a.charAt(0).toUpperCase(),a.slice(1)," "],b="snippet"===a?"id":"articleimageid",c.push(parseInt(e.data(b))),$.each(e.data(),function(a,b){"id"!==a&&"articleimageid"!==a&&c.push(" ",a,'="',b,'"')}),c.push(" ",d[a],">"),c.join("")})})}),b.html().replace(/\&lt\;\*\*/g,"<!**").replace(/\*\*\&gt\;/g,">").replace(/\&lt\;\-\-/g,"<--").replace(/\-\-\&gt\;/g,"-->"))}function h(a){return f(e(a))}var i,j=new XRegExp("(\\p{Letter}|\\d)+","g");return i=function(a){var b=this;a=a||{},a.fields=a.fields||{},angular.extend(b,a),b.articleId=b.number,delete b.number,Object.keys(b.fields).forEach(function(a){var c=b.fields[a];"string"==typeof c&&(b.fields[a]=h(c))}),b.comments_locked=!!parseInt(b.comments_locked),b.comments_enabled=!!parseInt(b.comments_enabled),b.statusString=_.property(a.status)(_.invert(i.wfStatus))},i.commenting=Object.freeze({ENABLED:0,DISABLED:1,LOCKED:2}),i.wfStatus=Object.freeze({NEW:"N",SUBMITTED:"S",PUBLISHED:"Y",PUBLISHED_W_ISS:"M"}),i.issueWfStatus=Object.freeze({NOT_PUBLISHED:"N",PUBLISHED:"Y"}),i.getById=function(c,d){var e,f=b.defer();return e=Routing.generate("newscoop_gimme_articles_getarticle",{number:c,language:d},!0),a.get(e).success(function(a){var b=new i(a);f.resolve(b)}).error(function(a){f.reject(a)}),f.promise},i.textStats=function(a){var b,c={};return a?(a=$("<div/>").html(a).text(),c.chars=a.length,b=a.match(j),c.words=b?b.length:0):(c.chars=0,c.words=0),c},i.prototype.loadContentFields=function(){var a=this,c=[],e=b.defer();return c.$promise=e.promise,d.getByName(a.type).then(function(a){a.fields.forEach(function(a){return a.isContentField?void c.unshift(a.name):!a.showInEditor||"body"!==a.type&&"longtext"!==a.type?void 0:void c.unshift(a.name)}),e.resolve(c)}),e.promise},i.prototype.loadFirstImage=function(){var c=this,d=b.defer(),e=Routing.generate("newscoop_gimme_images_getimagesforarticle",{number:c.articleId,language:c.language},!0);return a.get(e).success(function(a){a.items.length>0?d.resolve(a.items[0].basename):d.reject("Empty List")}).error(function(a){d.reject(a)}),d.promise},i.prototype.searchArticles=function(c,d){var e,f=[],g=b.defer(),h={};return f.$promise=g.promise,_.isEmpty(d)||(h=d),h.items_per_page=20,h.query=c,e=Routing.generate("newscoop_gimme_articles_searcharticles",h,!0),a.get(e).success(function(a){a.items.forEach(function(a){var b=new i(a);f.push(b)}),g.resolve(f)}).error(function(a){g.reject(a)}),g.promise},i.prototype.getRelatedArticles=function(){var c,d=[],e=this,f=b.defer();return d.$promise=f.promise,c=Routing.generate("newscoop_gimme_articles_related",{number:e.articleId,language:e.language},!0),a.get(c).success(function(a){a.items.forEach(function(a){var b=new i(a);d.push(b)}),f.resolve()}).error(function(a){f.reject(a)}),d},i.prototype.addRelatedArticle=function(c){var d=b.defer(),e=this,f=[];return f=["<"+Routing.generate("newscoop_gimme_articles_getarticle",{number:c.articleId},!1)+'; rel="topic">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:e.articleId,language:e.language},!0),method:"LINK",headers:{link:f}}).success(function(){d.resolve()}).error(function(a){d.reject(a)}),d.promise},i.prototype.removeRelatedArticle=function(c){var d,e=b.defer(),f=this;return d=["<",Routing.generate("newscoop_gimme_articles_getarticle",{number:c.articleId},!1),'; rel="topic">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:f.articleId,language:f.language},!0),method:"UNLINK",headers:{link:d}}).success(function(){e.resolve()}).error(function(a){e.reject(a)}),e.promise},i.prototype.save=function(){var d,e=b.defer(),f={article:{fields:{}}},h=this;return d=Routing.generate("newscoop_gimme_articles_patcharticle",{number:h.articleId,language:h.language},!0),angular.extend(f.article.fields,h.fields),delete f.article.fields.show_on_front_page,delete f.article.fields.show_on_section_page,f.article.name=h.title,Object.keys(f.article.fields).forEach(function(a){f.article.fields[a]=g(f.article.fields[a])}),a.patch(d,f,{transformRequest:c.formEncode}).success(function(){e.resolve()}).error(function(a){e.reject(a)}),e.promise},i.prototype.saveSwitches=function(d){var e,f=b.defer(),g={article:{fields:{}}},h=this;return e=Routing.generate("newscoop_gimme_articles_patcharticle",{number:h.articleId,language:h.language},!0),d.forEach(function(a){"show_on_front_page"!==a&&"show_on_section_page"!==a&&(g.article.fields[a]=h.fields[a]?1:0)}),g.article.onFrontPage=h.fields.show_on_front_page?1:0,g.article.onSection=h.fields.show_on_section_page?1:0,g.article.name=h.title,a.patch(e,g,{transformRequest:c.formEncode}).success(function(){f.resolve()}).error(function(a){f.reject(a)}),f.promise},i.prototype.changeCommentingSetting=function(d){var e,f=b.defer(),g={article:{}},h=this;return e=Routing.generate("newscoop_gimme_articles_patcharticle",{number:h.articleId,language:h.language},!0),g.article={comments_enabled:d===i.commenting.ENABLED?1:0,comments_locked:d===i.commenting.LOCKED?1:0},g.article.name=h.title,a.patch(e,g,{transformRequest:c.formEncode}).success(function(){f.resolve()}).error(function(a){f.reject(a)}),f.promise},i.prototype.setWorkflowStatus=function(b){var c=Routing.generate("newscoop_gimme_articles_changearticlestatus",{number:this.articleId,language:this.language,status:b},!0);return a.patch(c)},i.prototype.releaseLock=function(){function c(){f.isLocked=!1,e.resolve()}var d,e=b.defer(),f=this;return d=Routing.generate("newscoop_gimme_articles_changearticlelockstatus",{number:this.articleId,language:this.language},!0),a["delete"](d).success(c).error(function(a,b){403===b?c():e.reject(a)}),e.promise},i.prototype.setOrderOfRelatedArticles=function(c,d){var e=this,f=b.defer(),g=[];return g=["<"+Routing.generate("newscoop_gimme_articles_getarticle",{number:c.articleId},!1)+'; rel="article">,<'+(d+1)+'; rel="article-position">'].join(""),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:e.articleId,language:e.language},!0),method:"LINK",headers:{link:g}}).success(function(){f.resolve()}).error(function(a){f.reject(a)}),f.promise},i}]),angular.module("authoringEnvironmentApp").factory("ArticleType",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=new d;return b.name=a.name,b.fields=[],a.fields.forEach(function(a){a.isHidden=!!parseInt(a.isHidden),a.showInEditor=!!parseInt(a.showInEditor),a.isContentField=!!parseInt(a.isContentField),b.fields.push(angular.copy(a))}),b},d.getByName=function(c){var e=b.defer(),f=Routing.generate("newscoop_gimme_articletypes_getarticletype",{name:c},!0);return a.get(f).success(function(a){e.resolve(d.createFromApiData(a))}).error(function(a){e.reject(a)}),e.promise},d.createFromApiData=c.createFromApiData,d}]),angular.module("authoringEnvironmentApp").directive("sfDroppable",["$compile","Dragdata",function(a,b){var c,d,e;return e="h1, h2, h3, h4, h5, h6, ol, p, pre, table, ul",d="drag-drop-placeholder",c="."+d,{restrict:"A",link:function(f,g,h){function i(){var a=$("<div>&nbsp;</div>").addClass(d).attr("contenteditable",!1);return a}function j(){var a=Aloha.getEditableById(m.attr("id"));a&&(a.activate(),Aloha.trigger("aloha-smart-content-changed",{editable:a,triggerType:"paste",snapshotContent:a.getContents()}))}function k(d){var g,h,i=$(d.target);d.preventDefault(),d.stopPropagation(),l=0,$(c).remove();var k=d.originalEvent.dataTransfer.getData("Text");k&&(g=b.getDropped(k),h=a(g)(f)),i.is(e)?i.after(h):m.prepend(h),j()}var l,m=$(g);l=0,m.on("dragover",e,function(a){var b=$(a.target);b.next().is(c)||b.after(i())}),m.on("dragleave",e,function(a){var b=$(a.target).next();b.is(c)&&b.remove()}),m.on("drop",e,k),m.on("dragenter",function(a){var b;l++,m.children(":first").is(c)||(b=i(),b.on("dragenter",function(){b.addClass("drag-over")}),b.on("dragleave",function(){b.removeClass("drag-over")}),m.prepend(b))}),m.on("dragleave",function(a){var b=m.children(":first");l--,1>l&&b.is(c)&&b.remove()}),m.on("drop",k)}}}]),angular.module("authoringEnvironmentApp").directive("sfDraggable",["Dragdata","$log",function(a,b){function c(b){b.attr("draggable",!0),b.addClass("draggable"),b.on("dragstart",function(c){var d=a.getData(b);c.originalEvent.dataTransfer.setData("Text",d)})}function d(a){a.attr("draggable",!1),a.removeClass("draggable")}return{restrict:"A",scope:{allowDrag:"=sfDraggable"},link:function(e,f,g){var h=a.checkDraggable(f);h&&b.debug(h),e.$watch(function(){return e.allowDrag},function(a){a?c(f):d(f)})}}}]),function(){function a(a,b,c){function d(a){a.attr("draggable",!0),a.on("dragstart",function(b){var c;f.children().each(function(a,b){$(b).attr("data-sort-index",a)}),c={sortIndex:parseInt(a.attr("data-sort-index"),10)},i=c.sortIndex,b.originalEvent.dataTransfer.setData("text/plain",JSON.stringify(c)),b.originalEvent.dataTransfer.effectAllowed="move",a.addClass("dragged")}),a.on("dragend",function(b){a.removeClass("dragged"),h&&h.remove(),f.children().each(function(a,b){$(b).removeAttr("data-sort-index")}),g=-1,i=-1}),a.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("dragover",function(b){var c,d,e,j,k=parseInt(a.attr("data-sort-index"),10);if(b.originalEvent.preventDefault(),b.originalEvent.stopPropagation(),b.originalEvent.dataTransfer.dropEffect="move",e=void 0===b.originalEvent.offsetY?b.originalEvent.pageY-a.offset().top:b.originalEvent.offsetY,c=a.outerHeight(),d=c/2>e?k:k+1,d!==g){if(g=d,h&&h.remove(),g===i||g===i+1)return;h=$('<div class="new-item-slot"></div>'),j=f.children().eq(g),j.length>0?h.insertBefore(j):f.append(h)}}),a.on("drop",function(a){a.originalEvent.preventDefault()})}function e(a,b){a.on("dragover",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("dragenter",function(a){a.originalEvent.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move"}),a.on("drop",function(a){var c,d,e;a.originalEvent.preventDefault(),a.originalEvent.stopPropagation(),c=a.originalEvent.dataTransfer.getData("text/plain"),c=JSON.parse(c),e=c.sortIndex,g>e&&(g-=1),e!==g&&(d=b.items.splice(e,1)[0],b.items.splice(g,0,d),b.$apply(),b.orderChangedCallback({affectedItem:d,newIndex:g}))})}var f,g=-1,h=null,i=-1;f=$(b[0]),a.$watchCollection("items",function(a,b){var c=f.children(),e=_.difference(a,b);angular.forEach(c,function(b,c){_.indexOf(e,a[c])>-1&&d($(b))})}),e(f,a)}angular.module("authoringEnvironmentApp").directive("dragSort",[function(){return{restrict:"A",scope:{items:"=",orderChangedCallback:"&onOrderChanged"},link:a}}])}(),angular.module("authoringEnvironmentApp").service("Dragdata",["$log",function(a){this.converters={test:function(a){return{}},image:function(a){return{id:a.attr("data-id"),articleImageId:a.attr("data-articleimageid"),width:a.attr("data-width")}},embed:function(a){return{id:a.attr("data-id")}}},this.available=function(){var a=[];return angular.forEach(this.converters,function(b,c){a.push(c)}),a},this.checkDraggable=function(a){var b=a.attr("data-draggable-type");return b?b in this.converters?!1:'error: draggable type "'+b+'" is not supported':"error: a draggable element has not a data-draggable-type attribute"},this.getData=function(a){var b=a.attr("data-draggable-type"),c=this.converters[b],d=c(a);return d.type=b,JSON.stringify(d)},this.getDropped=function(b){var c=JSON.parse(b);switch(c.type){case"test":return $("<div>").text("test dropped");case"image":return Aloha.jQuery("<div>").addClass("aloha-image-block").data({id:c.id}).data({articleimageid:c.articleImageId}).alohaBlock({"aloha-block-type":"ImageBlock"});case"embed":return Aloha.jQuery("<div>").addClass("snippet").addClass("aloha-snippet-block").data({id:c.id}).append($("<dropped-snippet>").attr({"data-snippet-id":c.id})).alohaBlock({"aloha-block-type":"SnippetBlock"});default:a.debug("getDropped function called on a malformed data object, no known type into it")}}}]),angular.module("authoringEnvironmentApp").factory("SnippetTemplate",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=new d;return["id","name","enabled","favourite"].forEach(function(c){b[c]=a[c]}),b.fields=[],_.forEach(a.fields,function(a,c){if("frontend"===a.scope){switch(a["default"]="",b.name){case"Embed.ly":"maxwidth"===a.name&&(a["default"]="560");break;case"Youtube":"width"===a.name&&(a["default"]="560"),"height"===a.name&&(a["default"]="315")}b.fields.push(angular.copy(a))}}),b},d.getAll=function(){var d=b.defer(),e=[];return e.$promise=d.promise,a.get(Routing.generate("newscoop_gimme_snippettemplates_getsnippettemplates",{},!0),{params:{items_per_page:99999}}).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),e.push(a)}),d.resolve()}).error(function(a){d.reject(a)}),e},d.createFromApiData=c.createFromApiData,d}]),angular.module("authoringEnvironmentApp").factory("Snippet",["$http","$q",function(a,b){var c=this,d=function(){};return c.createFromApiData=function(a){var b=new d;return["id","templateId","name","render"].forEach(function(c){b[c]=a[c]}),b},d.getAllByArticle=function(d,e){var f,g=b.defer(),h=[];return h.$promise=g.promise,f={params:{rendered:!0,items_per_page:99999}},a.get(Routing.generate("newscoop_gimme_snippets_getsnippetsforarticle_1",{number:d,language:e},!0),f).success(function(a){a.items&&a.items.forEach(function(a){a=c.createFromApiData(a),h.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),h},d.getById=function(d){var e=b.defer(),f=Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:d},!0);return a.get(f,{params:{rendered:!0}}).success(function(a){e.resolve(c.createFromApiData(a))}).error(function(a){e.reject(a)}),e.promise},d.create=function(d,e,f){var g,h=b.defer();return g={template:e,snippet:{name:d,fields:{}}},_.forEach(f,function(a,b){g.snippet.fields[b]={data:a}}),a.post(Routing.generate("newscoop_gimme_snippets_createsnippet",{},!0),g).then(function(b){var c=b.headers("x-location");return a.get(c,{params:{rendered:!0}})},function(){return b.reject()}).then(function(a){var b=c.createFromApiData(a.data);h.resolve(b)},function(){h.reject()}),h.promise},d.prototype.addToArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:f.id},!1)+'; rel="snippet">',a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},d.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_snippets_getsnippet",{snippetId:f.id},!1)+'; rel="snippet">',a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},d}]),angular.module("authoringEnvironmentApp").service("snippets",["$log","article","Snippet",function(a,b,c){var d=b.articleInstance,e=this;e.article=d,e.attached=c.getAllByArticle(d.articleId,d.language),e.inArticleBody={},e.addToIncluded=function(a){e.inArticleBody[a]=!0},e.removeFromIncluded=function(a){delete e.inArticleBody[a]},e.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},e.addToArticle=function(b,c){var d,f=e.matchMaker(b.id);return _.find(e.attached,f)?void a.warn("Snippet",b.id,"is already attached."):(d=b.addToArticle(c.articleId,c.language),d.then(function(){e.attached.push(b)}),d)},e.removeFromArticle=function(b,c){var d,f=e.matchMaker(b.id);return _.find(e.attached,f)?(d=b.removeFromArticle(c.articleId,c.language),d.then(function(){_.remove(e.attached,f)}),d):void a.warn("Snippet",b.id,"is already detached.")}}]),angular.module("authoringEnvironmentApp").controller("PaneSnippetsCtrl",["$scope","$q","article","Snippet","SnippetTemplate","snippets","modalFactory","toaster","TranslationService",function(a,b,c,d,e,f,g,h,i){var j=c.articleInstance;a.clearNewSnippetForm=function(){a.newSnippet.name="",a.newSnippet.template=null,a.snippetTemplates.forEach(function(a){a.fields.forEach(function(a){delete a.value})})},a.addNewSnippetToArticle=function(c){var e,g={};a.addingNewSnippet=!0,c.template.fields.forEach(function(a){g[a.name]=a.value}),d.create(c.name,c.template.id,g).then(function(a){return e=a,f.addToArticle(e,j).then(function(){h.add({type:"sf-info",message:i.trans("aes.msgs.snippets.add.success")})},function(){h.add({type:"sf-error",message:i.trans("aes.msgs.snippets.add.error")})})},function(){return h.add({type:"sf-error",message:i.trans("aes.msgs.snippets.add.error")}),b.reject()}).then(function(){a.showAddSnippet=!1,a.clearNewSnippetForm()},b.reject)["finally"](function(){a.addingNewSnippet=!1})},a.confirmRemoveSnippet=function(a){var b,c,d;c=i.trans("aes.msgs.snippets.remove.popupHead"),d=i.trans("aes.msgs.snippets.remove.popup"),b=g.confirmLight(c,d),b.result.then(function(){f.removeFromArticle(a,j).then(function(){h.add({type:"sf-info",message:i.trans("aes.msgs.snippets.remove.success")})},function(){h.add({type:"sf-error",message:i.trans("aes.msgs.snippets.remove.error")})})})},a.inArticleBody=function(a){return!!f.inArticleBody[a]},a.showAddSnippet=!1,a.newSnippet={name:"",template:null},a.addingNewSnippet=!1,a.inputFieldTypes=Object.freeze({integer:"number",text:"text",url:"url"}),a.snippetTemplates=e.getAll(),a.snippets=f.attached,a.$watchCollection(f.attached,function(){a.snippets=f.attached})}]),angular.module("authoringEnvironmentApp").controller("DroppedSnippetCtrl",["$scope","$sce","$rootScope","Snippet","snippets",function(a,b,c,d,e){a.expanded=!1,a.snippets=e,this.init=function(c){d.getById(c).then(function(c){a.snippetHtml=b.trustAsHtml(c.render),a.snippet=c,e.addToIncluded(c.id)})},this.snippetRemoved=function(a){e.removeFromIncluded(a),c.$apply(e.inArticleBody)},a.expand=function(){a.expanded=!0},a.collapse=function(){a.expanded=!1}}]),angular.module("authoringEnvironmentApp").directive("droppedSnippet",[function(){return{restrict:"E",
templateUrl:"views/dropped-snippet.html",controller:"DroppedSnippetCtrl",scope:{snippetId:"@"},link:function(a,b,c,d){var e=parseInt(a.snippetId);b.find(".remove").on("click",function(){b.parent().remove(),d.snippetRemoved(parseInt(a.snippetId,10))}),d.init(e)}}}]),angular.module("authoringEnvironmentApp").directive("autoListOffset",[function(){return{restrict:"A",link:function(a,b,c){function d(){var a=Math.round(f.outerHeight());0!==a&&(i?(a=e,i=!1):a+=h,g.css("top",a))}var e,f,g,h=125,i=!0;e=parseInt(c.autoListOffset),(isNaN(e)||1>e)&&(e=150),f=b.find(".paneFormWrapper"),g=b.find(".list"),f.mutate("height",function(a,b){d()}),d()}}}]),angular.module("authoringEnvironmentApp").factory("NcImage",["$http","$q","$upload","transform","formDataFactory",function(a,b,c,d,e){var f;return f=function(a){var b,c=this;b=["id","articleImageId","basename","thumbnailPath","description","photographer","photographerUrl"],a=a||{},b.forEach(function(b){c[b]=a[b]}),c.width="width"in a?parseInt(a.width,10):void 0,c.height="height"in a?parseInt(a.height,10):void 0},f.getById=function(c){var d=b.defer();return a.get(Routing.generate("newscoop_gimme_images_getimage",{number:c},!0)).success(function(a){d.resolve(new f(a))}).error(function(a){d.reject(a)}),d.promise},f.query=function(c,d,e){var g,h,i=b.defer(),j=[];return j.$promise=i.promise,g={params:{expand:!0,items_per_page:d,page:c}},e&&(g.params.query=e),h=Routing.generate("newscoop_gimme_images_searchimages",{},!0),a.get(h,g).success(function(a){a=a||{},a.items&&a.items.forEach(function(a){a=new f(a),j.push(a)}),i.resolve({items:j,pagination:a.pagination})}).error(function(a){i.reject(a)}),j},f.getAllByArticle=function(c,d){var e,g=b.defer(),h=[];return h.$promise=g.promise,e={params:{expand:!0,items_per_page:99999}},a.get(Routing.generate("newscoop_gimme_images_getimagesforarticle",{number:c,language:d},!0),e).success(function(a){a.items&&a.items.forEach(function(a){a=new f(a),h.push(a)}),g.resolve(h)}).error(function(a){g.reject(a)}),h},f.addAllToArticle=function(c,d,e){var f=b.defer(),g=[];return e.forEach(function(a){g.push("<"+Routing.generate("newscoop_gimme_images_getimage",{number:a.id},!1)+'; rel="image">')}),g=g.join(","),a({url:Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),method:"LINK",headers:{link:g}}).success(function(){f.resolve()}).error(function(a){f.reject(a)}),f.promise},f.upload=function(a,d){var f,g=b.defer(),h=e.makeInstance(),i="No x-location header in API response.";return"function"!=typeof d&&(d=function(){}),h.append("image[image]",a),h.append("image[photographer]",a.photographer||""),h.append("image[description]",a.description||""),c.http({method:"POST",url:Routing.generate("newscoop_gimme_images_createimage",{},!0),data:h,headers:{"Content-Type":void 0},transformRequest:angular.identity}).progress(d).success(function(a,b,c,e){var h,j;d({loaded:100,total:100}),j=c()["x-location"],j?(f=j.split("/"),h=parseInt(f[f.length-1],10),g.resolve({id:h,url:j})):g.reject(i)}).error(function(){g.reject("error uploading")}),g.promise},f.prototype.updateDescription=function(c){var e,f,g=b.defer(),h=this;return f=Routing.generate("newscoop_gimme_images_updateimage",{number:h.id,_method:"PATCH"},!0),e={image:{description:c}},a.post(f,e,{transformRequest:d.formEncode}).success(function(a){h.description=c,g.resolve()}).error(function(a){g.reject(a)}),g.promise},f.prototype.removeFromArticle=function(c,d){var e,f=this,g=b.defer();return e="<"+Routing.generate("newscoop_gimme_images_getimage",{number:f.id},!1)+'; rel="image">',a({url:Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),method:"UNLINK",headers:{link:e}}).success(function(){g.resolve()}).error(function(a){g.reject(a)}),g.promise},f}]),angular.module("authoringEnvironmentApp").service("images",["pageTracker","$log","article","getFileReader","formDataFactory","imageFactory","NcImage","$rootScope","$q",function(a,b,c,d,e,f,g,h,i){var j,k=this,l=50;k.query=function(b){for(k.searchFilter=b;k.displayed.length>0;)k.displayed.pop();for(;k.loaded.length>0;)k.loaded.pop();k.tracker.reset(),k.itemsFound=0,k.canLoadMore=!1,k.load(k.tracker.next(),k.searchFilter).then(function(b){k.displayed=b.items,b.pagination?(k.itemsPerPage=b.pagination.itemsPerPage,k.itemsFound=b.pagination.itemsCount):(k.itemsPerPage=l,k.itemsFound=b.items.length),k.canLoadMore=!a.isLastPage(b.pagination),k.canLoadMore&&k.more()})},k.more=function(){var b=k.loaded.splice(0,k.itemsPerPage);k.displayed=k.displayed.concat(b),k.canLoadMore&&k.load(k.tracker.next(),k.searchFilter).then(function(b){k.loaded=k.loaded.concat(b.items),k.canLoadMore=!a.isLastPage(b.pagination)})},k.load=function(a,b){var c=g.query(a,k.itemsPerPage,b).$promise;return c["catch"](function(){k.tracker.remove(a)}),c},k.loadAttached=function(a){k.attached=g.getAllByArticle(a.articleId,a.language),k.attached.$promise.then(j.resolve,j.reject)},k.collect=function(a,b){var c;k.isCollected(a)||(b?g.getById(a).then(function(a){k.collected.push(a)}):(c=_.find(k.displayed,{id:a}),c&&k.collected.push(c)))},k.discard=function(a){_.remove(k.collected,{id:a})},k.discardAll=function(){for(;k.collected.length>0;)k.collected.pop();for(;k.images2upload.length>0;)k.images2upload.pop()},k.attachAllCollected=function(){var a=[],b=i.defer();return k.collected.forEach(function(b){_.find(k.attached,b)||a.push(b)}),a.length<1?void 0:(g.addAllToArticle(k.article.articleId,k.article.language,a).then(function(){b.resolve(),k.loadAttached(k.article)},function(a){b.reject(a)}),b.promise)},k.detach=function(a){var b=_.find(k.attached,{id:a}),c=i.defer();if(b)return b.removeFromArticle(k.article.articleId,k.article.language).then(function(){c.resolve(),_.remove(k.attached,{id:a})},function(a){c.reject(a)}),c.promise},k.addToIncluded=function(a){k.inArticleBody[a]=!0},k.removeFromIncluded=function(a){delete k.inArticleBody[a]},k.findAttached=function(a){return _.find(k.attached,{id:a})},k.findCollected=function(a){return _.find(k.collected,{id:a})},k.byId=function(a){var b=k.findAttached(a);if(b)return b;throw new Error("asking details about an image which is not attached to the article is not supported")},k.byArticleImageId=function(a){var b=_.find(k.attached,{articleImageId:a});if(b)return b;throw new Error("Could not find an image with the given articleImageId in the attached images list.")},k.isAttached=function(a){return"undefined"!=typeof k.findAttached(a)},k.isCollected=function(a){return"undefined"!=typeof k.findCollected(a)},k.togglerClass=function(a){return k.isCollected(a)?"glyphicon-minus":"glyphicon-plus"},k.toggleCollect=function(a){k.isCollected(a)?k.discard(a):k.collect(a)},k.addToUploadList=function(a){var b,c;for(b=0;b<a.length;b++)c=k.decorate(a[b]),k.images2upload.push(c),c.readRawData()},k.removeFromUploadList=function(a){_.remove(k.images2upload,a)},k.clearUploadList=function(){for(;k.images2upload.length>0;)k.images2upload.pop()},k.uploadAll=function(){var a,b=[];return k.images2upload.forEach(function(c){a=g.upload(c,c.progressCallback),b.push(a)}),b},k.decorate=function(a){return a.progress=0,a.max=0,a.percent="0%",a.progressCallback=function(b){a.progress=b.loaded,a.max=b.total,a.percent=Math.round(b.loaded/b.total*100)+"%"},a.readRawData=function(){var b=i.defer(),c=d.get();return c.onload=function(){var d=f.makeInstance();d.onload=function(c){a.width=d.width,a.height=d.height,a.src=d.src,b.resolve(c.target.result),h.$apply()},d.src=c.result},c.readAsDataURL(a),b.promise},a},j=i.defer(),k.attachedLoaded=j.promise,k.article=c.articleInstance,k.loadAttached(k.article),k.tracker=a.getTracker({max:100}),k.loaded=[],k.displayed=[],k.collected=[],k.images2upload=[],k.includedIndex=-1,k.inArticleBody={},k.itemsPerPage=l,k.itemsFound=0,k.searchFilter="",k.canLoadMore=!1}]),angular.module("authoringEnvironmentApp").service("modal",["$templateCache","$log","$http",function(a,b,c){var d="#myModal",e=this;this.visible=!1,this.show=function(a){this.title=a.title,this.url=a.templateUrl,this.windowClass="large",void 0!==a.windowClass&&(this.windowClass=a.windowClass),a.backdrop="static",a.keyboard=!1,a.show=!0,$(d).modal(a),e.visible=!0},this.hide=function(){this.visible=!1,$(d).modal("hide")}}]),angular.module("authoringEnvironmentApp").controller("ModalCtrl",["$scope","modal",function(a,b){a.modal=b}]),angular.module("authoringEnvironmentApp").controller("ImagePaneCtrl",["$scope","images","modal","modalFactory","toaster","TranslationService",function(a,b,c,d,e,f){a.images=b,a.defaultWidth="100%",a.root=AES_SETTINGS.API.rootURI,a.attachModal=function(){b.searchFilter="",b.query(),c.show({title:"Attach Image",templateUrl:"views/attach-image.html"})},a.detachingAllowed=function(a){return!b.inArticleBody[a]},a.detachImage=function(a){var c,g,h;g=f.trans("aes.msgs.images.detach.popupHead"),h=f.trans("aes.msgs.images.detach.popup"),c=d.confirmLight(g,h),c.result.then(function(c){b.detach(a).then(function(){e.add({type:"sf-info",message:f.trans("aes.msgs.images.detach.success")})},function(){e.add({type:"sf-error",message:f.trans("aes.msgs.images.detach.error")})})},function(a){})}}]),angular.module("authoringEnvironmentApp").controller("MediaArchiveCtrl",["$scope","images",function(a,b){a.images=b,a.root=AES_SETTINGS.API.rootURI,a.searchFilter="",a.$watch("images.searchFilter",function(b,c){a.appliedFilter=b}),a.clearSearch=function(){b.searchFilter="",b.query()},a.thumbnailClicked=function(a){var c=b.isAttached(a),d=b.isCollected(a);c||d||b.toggleCollect(a)},a.searchArchive=function(a){b.query(a)},a.loadMore=function(){b.more()}}]),angular.module("authoringEnvironmentApp").controller("AttachImageCtrl",["$scope","$q","images","modal","toaster","TranslationService",function(a,b,c,d,e,f){a.root=AES_SETTINGS.API.rootURI,a.images=c,a.sources=[{value:"computer",url:"views/attach-image/computer.html",description:"From Computer"},{value:"archive",url:"views/attach-image/archive.html",description:"Media Archive"}],a.selected=a.sources[1],a.select=function(b){a.selected=b},a.attachCollected=function(){c.attachAllCollected().then(function(){e.add({type:"sf-info",message:f.trans("aes.msgs.images.attach.success")}),c.discardAll(),d.hide()},function(){e.add({type:"sf-error",message:f.trans("aes.msgs.images.attach.error")})})},a.discardChanges=function(a){a.preventDefault(),a.stopPropagation(),c.discardAll(),d.hide()}}]),angular.module("authoringEnvironmentApp").controller("UploadFromCompCtrl",["$scope","images","$q",function(a,b,c){a.images2upload=b.images2upload,a.uploading=!1,a.$watchCollection("images.images2upload",function(b,c){a.images2upload=b}),a.addToUploadList=function(c){b.addToUploadList(c),a.$apply()},a.removeFromStaging=function(a){b.removeFromUploadList(a)},a.uploadStaged=function(){var d;a.uploading=!0,d=b.uploadAll(),c.all(d).then(function(a){a.forEach(function(a){b.collect(a.id,!0)}),b.clearUploadList()})["finally"](function(){a.uploading=!1})},a.clearStaged=function(){b.clearUploadList()},a.setForAllPhotographer=function(a){b.images2upload.forEach(function(b){b.photographer=a})},a.setForAllDescription=function(a){b.images2upload.forEach(function(b){b.description=a})}}]),angular.module("authoringEnvironmentApp").service("pageTracker",function(){this.isLastPage=function(a){if("undefined"==typeof a)return!0;["itemsPerPage","currentPage","itemsCount"].map(function(b){a[b]=parseInt(a[b],10)});var b=a.itemsCount/a.itemsPerPage;return a.currentPage>=b},this.getTracker=function(a){return{counter:1,pages:{},remove:function(a){delete this.pages[a]},has:function(a){return a in this.pages},next:function(){for(var a=1;a<=this.counter;a++)if(this.has(a)===!1)return this.pages[a]=!0,a===this.counter&&this.counter++,a},reset:function(){this.pages={},this.counter=1}}}}),function(){function a(a){var b=[];this.toggleToolbar=function(a){var c="none"===a.css("display");_.find(b,a)||b.push(a),c&&b.forEach(function(a){a.hide()}),a.toggle(c)},this.deregisterToolbar=function(a){_.remove(b,a)},a.$on("texteditor-editable-deactivated",function(){b.forEach(function(a){a.hide()})})}a.$inject=["$rootScope"],angular.module("authoringEnvironmentApp").directive("droppedImagesContainer",function(){return{restrict:"A",controller:a}})}(),angular.module("authoringEnvironmentApp").directive("droppedImage",["$log","$timeout",function(a,b){return{restrict:"A",templateUrl:"views/dropped-image.html",controller:"DroppedImageCtrl",scope:{articleImageId:"@imageArticleimageid",alignment:"@imageAlign",size:"@imageSize"},require:["dropped-image","^^dropped-images-container"],link:function(c,d,e,f){function g(){return $('.aloha-image-block[data-articleimageid="'+c.articleImageId+'"]')}function h(){var a;return r=g(),l=$("#img-toolbar-"+c.image.id),(!l||l.length<1)&&(l=$("#img-toolbar-"+c.image.id),a=l.detach(),r.append(a)),l}function i(){var a,b,c,d=h();r=g(),a=r.css("float"),"left"===a?b=0:"right"===a?(b=r.outerWidth()-d.outerWidth(),b=Math.round(b)):(b=q.outerWidth()-d.outerWidth(),b=Math.round(b/2)),c=-(d.outerHeight()+15),h().css({left:b,top:c})}function j(a){a||(a=Aloha.getEditableById(r.parent(".aloha-editable-active").attr("id"))),a&&Aloha.trigger("aloha-smart-content-changed",{editable:a,triggerType:"paste",snapshotContent:a.getContents()})}function k(a,b){for(var c=document.styleSheets.length-1;c>=0;c--)for(var d=document.styleSheets[c].cssRules||document.styleSheets[c].rules||[],e=0;e<d.length;e++)if(d[e].selectorText===a)return d[e].style[b];return null}var l,m=f[0],n={},o=f[1],p=$(d),q=p.find(".dropped-image"),r=p.parent();c.activeSize=null,c.activeAlignment=null,p.find("button.close").click(function(a){var b=Aloha.getEditableById(r.parent(".aloha-editable-active").attr("id"));r.remove(),m.imageRemoved(c.image.id),j(b)}),p.find(".caption").click(function(a){a.stopPropagation()}),q.click(function(a){o.toggleToolbar(h())}),d.on("$destroy",function(){o.deregisterToolbar(h())}),c.setAlignment=function(b){var d,e;switch(b){case"left":d="left",e="2% 2% 2% 0",c.activeAlignment="left";break;case"right":d="right",e="2% 0 2% 2%",c.activeAlignment="right";break;case"middle":d="none",e="2% auto",c.activeAlignment="middle";break;default:return a.warn("unknown image alignment:",b),void(c.activeAlignment=null)}p.css({"float":d}),r=g(),r.css({"float":d,margin:e}),"middle"===b&&r.css({margin:"auto"}),r.attr("data-align",b),j(),i()},c.setSize=function(a,b){var d;if(r=g(),a.match(/^\d+px$/))return d=a.substring(0,a.length-2),c.changePixelSize(parseInt(d)),c.activeSize="custom",void i();if(a in AES_SETTINGS.image.width){d=AES_SETTINGS.image.width[a],c.activeSize=a,r.attr("data-percentage",d);var e=k(".authoring-environment .main-article-container.desktop","max-width"),f=parseInt(e)*(parseInt(d)/100);r.attr("data-sizepixels",f+"px")}else d=c.image.width+2+"px",c.activeSize="original",r.attr("data-sizepixels",p.innerWidth()+"px");r.css("width",d),p.css("width","100%"),r.attr("data-size",a),c.widthPx=p.innerWidth(),b&&(c.widthPx-=2),j(),i()},c.changePixelSize=function(a){angular.isNumber(a)&&a>0&&(a=Math.round(a),p.css("width",a+"px"),r=g(),r.css("width",a+2+"px"),r.attr("data-size",a+"px"),r.attr("data-sizepixels",a+"px"),r.attr("data-percentage","100%"),c.widthPx=a,c.activeSize="custom",j(),i())},n.alignment=c.alignment||"middle",n.size=c.size||AES_SETTINGS.image_size,m.init(parseInt(c.articleImageId,10)).then(function(){c.setAlignment(n.alignment),c.setSize(n.size,!0),b(i,0)})}}}]),angular.module("authoringEnvironmentApp").controller("DroppedImageCtrl",["images","$scope","NcImage","$rootScope","$q",function(a,b,c,d,e){this.init=function(c){var d=e.defer();return a.attachedLoaded.then(function(){b.image=a.byArticleImageId(c),a.addToIncluded(b.image.id),b.newCaption=b.image.description,d.resolve(b.image)}),d.promise},this.imageRemoved=function(b){a.removeFromIncluded(b),d.$apply(a.inArticleBody)},b.editCaptionMode=function(a){a&&(b.newCaption=b.image.description),b.editingCaption=a},b.updateCaption=function(){b.editingCaption=!1,b.image.updateDescription(b.newCaption)["catch"](function(){b.newCaption=b.image.description})},b.pasteCaption=function(a){b.newCaption=a.originalEvent.clipboardData.getData("text/plain")},b.editingCaption=!1,b.newCaption="",b.root=AES_SETTINGS.API.rootURI,b.images=a}]),angular.module("authoringEnvironmentApp").directive("fixedImagePlaceholder",function(){return{templateUrl:"views/fixed-image-placeholder.html",restrict:"E",link:function(a,b,c){b.on("drop",function(b){b.preventDefault();var c=b.originalEvent.dataTransfer.getData("Text");a.onDrop(c)})}}}),angular.module("authoringEnvironmentApp").controller("FixedImagePlaceholderCtrl",["$scope","images",function(a,b){a.root=AES_SETTINGS.API.rootURI,a.style={},a.dropped=!1,a.onDrop=function(c){var d=JSON.parse(c);"image"===d.type&&a.$apply(function(){a.image=b.byId(d.id),a.style.opacity=1,a.dropped=!0})}}]),angular.module("authoringEnvironmentApp").factory("authInterceptor",["$injector","$q",function(a,b){return{request:function(b){var c,d,e=a.get("userAuth");return c=Routing.generate("newscoop_gimme_articles_getarticles",{},!1),c=c.substring(1,c.lastIndexOf("/")),-1===b.url.indexOf(c+"/")?b:(b.headers=b.headers||{},d=e.token(),d&&!b.IS_AUTHORIZATION_HEADER&&(b.headers.Authorization="Bearer "+d),b)},responseError:function(c){var d,e,f,g,h;return g=a.get("userAuth"),c.config.IS_RETRY?b.reject(c):401===c.status||"OAuth2 authentication required"===c.statusText?(e=c.config,f=b.defer(),h=a.get("$http"),d=angular.copy(e),d.IS_RETRY=!0,g.obtainToken().then(function(a){h(d).then(function(a){delete a.config.IS_RETRY,f.resolve(a)})["catch"](function(){f.reject(c)})},function(a){g.newTokenByLoginModal().then(function(){h(d).then(function(a){delete a.config.IS_RETRY,f.resolve(a)})["catch"](function(){f.reject(c)})})["catch"](function(){f.reject(c)})}),f.promise):b.reject(c)}}}]),angular.module("authoringEnvironmentApp").service("addToUrl",function(){this.add=function(a,b){var c="";return angular.forEach(a,function(a,b){c+="&"+b+"="+a}),/[?]/.test(b)||(c="?"+c.slice(1)),b+c}}),angular.module("authoringEnvironmentApp").service("mode",function(){this.current="normal",this.zen=!1,this.goZen=function(){this.current="zen",this.zen=!0},this.goNormal=function(){this.current="normal",this.zen=!1}}),angular.module("authoringEnvironmentApp").service("platform",function(){var a=this;this.current="desktop",this.go={mobile:function(){a.current="mobile"},desktop:function(){a.current="desktop"},tablet:function(){a.current="tablet"}}}),angular.module("authoringEnvironmentApp").service("comments",["article","$http","$q","$resource","transform","pageTracker","$log","nestedSort",function(a,b,c,d,e,f,g,h){function i(a){return a.selected=!1,a.showStatus="collapsed",a.isEdited=!1,a.recommended=!!a.recommended,a.editing={status:a.status},a.reply={subject:"Re: "+a.subject,message:""},a.isReplyMode=!1,a.sendingReply=!1,a.collapse=function(){this.showStatus="collapsed",this.isReplyMode=!1},a.expand=function(){this.showStatus="expanded"},a.toggle=function(){"expanded"===this.showStatus?this.collapse():this.expand()},a.edit=function(){this.editing.subject=this.subject,this.editing.message=this.message,this.isEdited=!0,this.isReplyMode=!1},a.cancel=function(){this.isEdited=!1},a.save=function(){var a=this,b=c.defer();return l.resource.save({articleNumber:j.articleId,languageCode:j.language,commentId:a.id},{comment:a.editing},function(){b.resolve(),a.subject=a.editing.subject,a.message=a.editing.message,a.isEdited=!1},function(){b.reject()}),b.promise},a.remove=function(){var a=this;l.resource["delete"]({articleNumber:j.articleId,languageCode:j.language,commentId:a.id}).$promise.then(function(){_.remove(l.displayed,l.matchMaker(a.id))})},a.replyTo=function(){a.isReplyMode=!0},a.cancelReply=function(){a.isReplyMode=!1},a.sendReply=function(){var a=this,b=c.defer(),d=angular.copy(a.reply);return d.parent=a.id,a.sendingReply=!0,l.add({comment:d}).then(function(){b.resolve(),a.sendingReply=!1,a.isReplyMode=!1,a.reply={subject:"Re: "+a.subject,message:""}},function(){b.reject()}),b.promise},a.toggleRecommended=function(){var a=this,b=!a.recommended;l.resource.toggleRecommended({commentId:a.id},{comment:{recommended:b?1:0}},function(){a.recommended=b})},a.changeStatus=function(a){var b=this;l.resource.patch({articleNumber:j.articleId,languageCode:j.language,commentId:b.id},{comment:{status:a}},function(){b.status=a},function(){g.debug("error changing the status for the comment")})},a}var j=a.articleInstance,k=50,l=this,m="nested";l.canLoadMore=!0,l.loaded=[],l.displayed=[],l.tracker=f.getTracker(),l.resource=d(Routing.generate("newscoop_gimme_comments_getcommentsforarticle_1",{},!0)+"/:articleNumber/:languageCode",{},{create:{method:"POST",transformRequest:e.formEncode},patch:{method:"PATCH",url:Routing.generate("newscoop_gimme_comments_updatecomment_1",{},!0)+"/:articleNumber/:languageCode/:commentId",transformRequest:e.formEncode},save:{method:"POST",url:Routing.generate("newscoop_gimme_comments_createcomment",{},!0)+"/:articleNumber/:languageCode/:commentId",transformRequest:e.formEncode},"delete":{method:"DELETE",url:Routing.generate("newscoop_gimme_comments_deletecomment_1",{},!0)+"/:articleNumber/:languageCode/:commentId"},toggleRecommended:{method:"PATCH",url:Routing.generate("newscoop_gimme_comments_updatecomment",{},!0)+"/:commentId.json"}}),l.add=function(a){var d=c.defer();return l.resource.create({articleNumber:j.articleId,languageCode:j.language},a,function(a,c){var e=c("X-Location");e?b.get(e).success(function(a){l.displayed.push(i(a)),h.sort(l.displayed)}):l.init(),d.resolve()}),d.promise},l.init=function(a){l.tracker=f.getTracker(),l.canLoadMore=!0,l.loaded=[],l.displayed=[],m=a&&a.sorting?a.sorting:"nested",l.load(l.tracker.next()).then(function(a){l.displayed=a.items.map(i),h.sort(l.displayed),l.canLoadMore&&l.load(l.tracker.next()).then(function(a){l.loaded=l.loaded.concat(a.items)})})},l.more=function(){if(l.canLoadMore){var a=l.loaded.splice(0,k);a=a.map(i),l.displayed=l.displayed.concat(a);var b=l.tracker.next();l.load(b).then(function(a){l.loaded=l.loaded.concat(a.items)})}else g.error("More comments required, but the service cannot load more of them. In this case the user should not be able to trigger this request")},l.load=function(a){var d,e,g=c.defer();return d="nested"===m?"nested":"",e=Routing.generate("newscoop_gimme_comments_getcommentsforarticle_1",{number:j.articleId,language:j.language,order:d,items_per_page:k,page:a},!0),b.get(e).success(function(a){g.resolve(a),f.isLastPage(a.pagination)&&(l.canLoadMore=!1)}).error(function(){l.tracker.remove(a)}),g.promise},l.matchMaker=function(a){return function(b){return parseInt(b.id)===parseInt(a)}},l.changeSelectedStatus=function(a,b,c){var d=null,e=l.displayed,f=0,g=e.length,h=[];if(!b&&"undefined"!=typeof c)return void e.forEach(function(b){b.id===c&&b.changeStatus(a)});if(!b&&"undefined"==typeof c)return void e.forEach(function(b){b.selected&&b.changeStatus(a)});if(b&&"undefined"!=typeof c)for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level))break;h.push(e[f])}else e[f].id===c&&(d=e[f],h.push(d));f++}else for(;g>f;){if(d){if(!(e[f].thread_level>d.thread_level)){d=null;continue}h.push(e[f])}else e[f].selected&&(d=e[f],h.push(d));f++}h.forEach(function(b){b.changeStatus(a)})}}]),angular.module("authoringEnvironmentApp").controller("CommentsCtrl",["$scope","comments","article","Article","modalFactory","$log","TranslationService","toaster",function(a,b,c,d,e,f,g,h){var i=c.articleInstance,j=["pending","approved","hidden"];a.sortings=[{text:"Nested"},{text:"Chronological"},{text:"Chronological (asc.)"}],a.sorting=a.sortings[0],a.toggle=function(b){var c=a.statuses[b];a.statuses[b]=!c,"all"===b?c?j.map(function(b){a.statuses[b]=!0}):j.map(function(b){a.statuses[b]=!1}):c?j.every(function(b){return!1===a.statuses[b]})&&(a.statuses.all=!0):a.statuses.all=!1},a.commentingSettingSrv=d.commenting.ENABLED,a.commentingSetting=a.commentingSettingSrv,a.commentingOptDirty=!1,a.isChangingCommenting=!1,a.commenting=d.commenting,a.commentingOpts=[{value:d.commenting.ENABLED,text:"Enabled"},{value:d.commenting.DISABLED,text:"Disabled"},{value:d.commenting.LOCKED,text:"Locked"}],this.initCommenting=function(){i.comments_locked?a.commentingSettingSrv=d.commenting.LOCKED:i.comments_enabled?a.commentingSettingSrv=d.commenting.ENABLED:a.commentingSettingSrv=d.commenting.DISABLED,a.commentingSetting=a.commentingSettingSrv},this.initCommenting(),a.statuses={all:!0,pending:!1,approved:!1,hidden:!1},a.selected=function(b){return a.statuses.all?!0:a.statuses[b.status]?!0:!1},a.isSending=!1,a.comments=b,a.create={},b.init(),a.add=function(c){a.isSending=!0,b.add(c).then(function(){a.adding=!1,a.isSending=!1,a.create={},h.add({type:"sf-info",message:g.trans("aes.msgs.comments.add.success")})},function(){a.isSending=!1,h.add({type:"sf-error",message:g.trans("aes.msgs.comments.add.error")})})},a.cancel=function(){a.adding=!1,a.create={}},a.globalShowStatus="collapsed",a.$watch("globalShowStatus",function(){b.displayed.map(function(b){b.showStatus=a.globalShowStatus})}),a.updateCommentingDirtyFlag=function(){a.commentingOptDirty=a.commentingSetting!==a.commentingSettingSrv},a.saveComment=function(a){a.save().then(function(){h.add({type:"sf-info",message:g.trans("aes.msgs.comments.edit.success")})},function(){h.add({type:"sf-error",message:g.trans("aes.msgs.comments.edit.error")})})},a.sendReply=function(a){a.sendReply().then(function(){h.add({type:"sf-info",message:g.trans("aes.msgs.comments.reply.success")})},function(){h.add({type:"sf-error",message:g.trans("aes.msgs.comments.reply.error")})})},a.changeCommentingSetting=function(){var b=a.commentingSetting,c=a.commentingSettingSrv;a.isChangingCommenting=!0,i.changeCommentingSetting(b).then(function(){a.commentingSettingSrv=b,h.add({type:"sf-info",message:g.trans("aes.msgs.comments.change.success")})},function(){a.commentingSetting=c,h.add({type:"sf-error",message:g.trans("aes.msgs.comments.change.error")})})["finally"](function(){a.updateCommentingDirtyFlag(),a.isChangingCommenting=!1})},a.toggleShowStatus=function(){a.globalShowStatus="expanded"===a.globalShowStatus?"collapsed":"expanded"},a.$watch("sorting",function(){f.debug("sorting changed"),b.canLoadMore&&("Nested"===a.sorting.text?b.init({sorting:"nested"}):b.init({sorting:"chronological"}))}),a.countSelected=function(){var a=0;return b.displayed.forEach(function(b){b.selected&&a++}),a},a.confirmHideComments=function(a){var c,d,f,i="undefined"!=typeof a;d=g.trans("aes.msgs.comments.hide.popupHead"),f=g.trans("aes.msgs.comments.hide.popup"),c=e.confirmLight(d,f),c.result.then(function(c){i?b.changeSelectedStatus("hidden",!1,a):b.changeSelectedStatus("hidden",!1),h.add({type:"sf-info",message:g.trans("aes.msgs.comments.hide.success")})},function(a){h.add({type:"sf-error",message:g.trans("aes.msgs.comments.hide.error")})})},a.confirmDeleteComments=function(a){var c,d,f,i="undefined"!=typeof a;d=g.trans("aes.msgs.comments.delete.popupHead"),f=g.trans("aes.msgs.comments.delete.popup"),c=e.confirmHeavy(d,f),c.result.then(function(c){i?b.changeSelectedStatus("deleted",!0,a):b.changeSelectedStatus("deleted",!0),h.add({type:"sf-info",message:g.trans("aes.msgs.comments.delete.success")})},function(a){h.add({type:"sf-error",message:g.trans("aes.msgs.comments.delete.error")})})}}]),angular.module("authoringEnvironmentApp").directive("comment",function(){return{templateUrl:"views/comment.html",restrict:"E",scope:{model:"=",allowreplying:"=",onHide:"&confirmHideComments",onDelete:"&confirmDeleteComments",onSave:"&saveComment",onReply:"&sendReply"},link:function(a,b,c){}}}),angular.module("authoringEnvironmentApp").service("transform",function(){function a(a){return $.param(a)}this.formEncode=function(b,c){var d=c();return d["Content-Type"]="application/x-www-form-urlencoded",a(b)},this.formEncodeData=a}),angular.module("authoringEnvironmentApp").service("circularBufferFactory",function(){this.create=function(a){if(!("size"in a))throw new Error("a circular buffer needs an integer size option");return{opt:a,arr:[],used:function(){return this.arr.length},push:function(a){this.used()>=this.opt.size&&this.arr.shift(),this.arr.push(a)},dump:function(){return angular.copy(this.arr)},prev:function(a){var b=a||1,c=parseInt(b,10);if(1>c)throw new Error(c+" is not a valid value for the `prev` function, check the tests or the code");var d=this.arr.length-c,e=d>=0?d:0;return this.arr[e]}}}}),angular.module("authoringEnvironmentApp").filter("sortComments",["$log",function(a){function b(a){var b=a.created.split(/[^0-9]/);return new Date(b[0],b[1]-1,b[2],b[3],b[4],b[5])}return function(c,d){var e,f;switch(d){case"Nested":return _.sortBy(c,"nestedPosition");case"Chronological":return e=_.sortBy(c,b),e.reverse(),e;case"Chronological (asc.)":return _.sortBy(c,b);default:throw f="unknown sorting: "+d,a.error(f),new Error(f)}}}]),angular.module("authoringEnvironmentApp").service("nestedSort",["$log",function(a){var b=this;this.sortByCreated=function(a){function b(a){var b=a.created.split(/[^0-9]/);return new Date(b[0],b[1]-1,b[2],b[3],b[4],b[5])}return _.sortBy(a,b)},this.sort=function(c){function d(a){var c=b.sortByCreated(a.childs);c.forEach(function(a){a.nestedPosition=i,i++,d(a)})}for(var e=[],f=0,g=function(a){return a.thread_level===f},h=c.filter(g);h.length>0;)e.push(h),f++,h=c.filter(g);b.map={root:{childs:[]}},e.forEach(function(c){c.forEach(function(c){var d=angular.copy(c);d.childs=[],0===d.thread_level&&(d.parent="root"),b.map[d.id]=d,"parent"in d?d.parent in b.map?b.map[d.parent].childs.push(d):a.debug("error, comment",d,"has parent",d.parent,"which is not available to us"):a.debug("error, comment",d,"is not first level but it has no parent")})});var i=0;d(b.map.root),c.forEach(function(c){c.id in b.map?c.nestedPosition=b.map[c.id].nestedPosition:a.error("comment",c,"is not in the nested sorting map",b.map)})}}]),angular.module("authoringEnvironmentApp").service("currentTime",function(){var a=!1;this.set=function(b){a=b},this.unset=function(){a=!1},this.get=function(){return a===!1?new Date:a},this.isToday=function(a){var b=this.get();return a.toDateString()===b.toDateString()}}),angular.module("authoringEnvironmentApp").filter("niceDate",["currentTime","$filter",function(a,b){return function(c){var d;if("string"==typeof c){var e=c.split(/[^0-9]/);d=new Date(e[0],e[1]-1,e[2],e[3],e[4],e[5])}else d=c;return a.isToday(d)?"today "+b("date")(d,"H:mm"):b("date")(d,"dd.MM.yyyy")}}]),angular.module("authoringEnvironmentApp").filter("stripHTML",[function(){var a=new RegExp(String.fromCharCode(160),"g");return function(b){return $("<div>").html(b).text().replace(a," ")}}]),angular.module("authoringEnvironmentApp").directive("dropImages",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b,c){b=$(b[0]),b.on("drop",function(b){var c,d,e,f=[],g=new RegExp(/^image\/.*/i);for(b.preventDefault(),b.stopPropagation(),e=b.originalEvent.dataTransfer.files,c=0;c<e.length;c++)d=e.item(c),g.test(d.type)&&f.push(d);a.handler({files:f})}),b.on("dragover",function(a){a.preventDefault(),a.stopPropagation(),a.originalEvent.dataTransfer.dropEffect="copy"})}}}),angular.module("authoringEnvironmentApp").directive("fileUpload",function(){return{restrict:"A",scope:{handler:"&"},link:function(a,b,c){var d=$("<input>").attr({type:"file",accept:"image/*",multiple:"multiple","class":"hidden-input",style:"display:none"});d.on("click",function(a){a.stopPropagation()}),d.on("change",function(b){var c=d.get(0).files;a.handler({files:c})}),b.append(d),b.on("click",function(a){d.click()})}}}),angular.module("authoringEnvironmentApp").factory("Author",["$http","$q","$timeout","dateFactory","pageTracker",function(a,b,c,d,e){var f=250,g=null,h=0,i=function(){};return i.createFromApiData=function(a){var b=new i;return b.id=a.author.id,b.firstName=a.author.firstName,b.lastName=a.author.lastName,b.text=a.author.firstName+" "+a.author.lastName,a.type?b.articleRole={id:a.type.id,name:a.type.type}:b.articleRole=null,a.author.image?b.avatarUrl=decodeURIComponent(a.author.image):b.avatarUrl="/bundles/newscoopeditor/images/authors-default-avatar.png",
b.sortOrder=a.order,b},i.getAllByArticle=function(c,d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_authors_getarticleauthors",{number:c,language:d,items_per_page:99999},!0),a.get(e).success(function(a){a.items.forEach(function(a){a=i.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},i.getRoleList=function(){var c,d=b.defer(),e=[];return e.$promise=d.promise,c=Routing.generate("newscoop_gimme_authors_getauthorstypes",{items_per_page:99999},!0),a.get(c).success(function(a){a.items.forEach(function(a){a.name=a.type,delete a.type,e.push(a)}),d.resolve()}).error(function(a){d.reject(a)}),e},i.liveSearchQuery=function(b,j){var k,l=b.page>1,m=d.makeInstance();if(!j){if(!l)return h=m,void c(function(){i.liveSearchQuery(b,!0)},f);if(angular.equals(b.context,g))return;g=b.context}!l&&f>m-h||(k=Routing.generate("newscoop_gimme_authors_searchauthors",{items_per_page:10,page:b.page,query:b.term},!0),a.get(k).success(function(a){var c,d=[];a.items.forEach(function(a){c=i.createFromApiData({author:a}),d.push(c)}),b.callback({results:d,more:!e.isLastPage(a.pagination),context:a.pagination})}))},i.setOrderOnArticle=function(b,c,d){var e=[];d.forEach(function(a){e.push(a.id+"-"+a.articleRole.id)}),e=e.join(),a.post(Routing.generate("newscoop_gimme_authors_setarticleauthorsorder",{number:b,language:c},!0),{order:e})},i.prototype.addToArticle=function(c,d,e){var f,g,h=this,i=b.defer();return f=["<",Routing.generate("newscoop_gimme_authors_getauthorbyid",{id:h.id},!1),'; rel="author">,',"<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:e},!1),'; rel="author-type">'].join(""),g=Routing.generate("newscoop_gimme_articles_linkarticle",{number:c,language:d},!0),a({url:g,method:"LINK",headers:{link:f}}).success(function(){h.articleRole=h.articleRole||{},h.articleRole.id=e,i.resolve()}).error(function(a){i.reject(a)}),i.promise},i.prototype.removeFromArticle=function(c,d,e){var f,g,h=this,i=b.defer();return f=["<",Routing.generate("newscoop_gimme_authors_getauthorbyid",{id:h.id},!1),'; rel="author">,',"<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:e},!1),'; rel="author-type">'].join(""),g=Routing.generate("newscoop_gimme_articles_unlinkarticle",{number:c,language:d},!0),a({url:g,method:"UNLINK",headers:{link:f}}).success(function(){i.resolve()}).error(function(a){i.reject(a)}),i.promise},i.prototype.updateRole=function(b){var c,d,e,f;return d=["<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:b.oldRoleId},!1),'; rel="old-author-type">,',"<",Routing.generate("newscoop_gimme_authors_getauthortype",{id:b.newRoleId},!1),'; rel="new-author-type">'].join(""),f=Routing.generate("newscoop_gimme_authors_updatearticleauthor",{number:b.number,language:b.language,authorId:this.id},!0),c={headers:{link:d}},e=a.post(f,{},c)},i}]),angular.module("authoringEnvironmentApp").factory("getFileReader",function(){return{get:function(){return new FileReader}}}),angular.module("authoringEnvironmentApp").factory("formDataFactory",function(){return{makeInstance:function(){return new FormData}}}),angular.module("authoringEnvironmentApp").factory("imageFactory",function(){return{makeInstance:function(){return new Image}}}),angular.module("authoringEnvironmentApp").factory("dateFactory",function(){return{makeInstance:function(){return new Date}}}),angular.module("authoringEnvironmentApp").controller("PaneRelatedArticlesCtrl",["$q","article","modalFactory","Publication","Issue","Section","toaster","TranslationService",function(a,b,c,d,e,f,g,h){var i=this;i.article=b.articleInstance,i.articlesSearchResults=[],i.articlesSearchResultsListRetrieved=!0,i.assignedRelatedArticles=[],i.assigningRelatedArticles=!1,i.previewLoaded=!0,i.availablePublications=d.getAll(),i.availableIssues=e.getAll(),i.availableSections=f.getAll(),i.assignedRelatedArticles=i.article.getRelatedArticles(),i.loadAvailableFilters=function(){var a=i.buildFilters();i.issueFilter||(i.availableIssues=e.getAll(a)),i.availableSections=f.getAll(a)},i.previewRelatedArticle=function(a){i.clearPreview(),a.loadFirstImage().then(function(b){var c=AES_SETTINGS.API.rootURI+"/images/";a.firstImage=b?c+b:null}),a.loadContentFields().then(function(b){a.contentFields=b,i.previewLoaded=!0}),a.editorUrl=Routing.generate("newscoop_admin_aes",{articleNumber:a.articleId,language:a.language},!0),i.relatedArticlePreview=a,i.showArticlePreview=!i.showArticlePreview},i.clearPreview=function(){i.previewLoaded=!1,i.relatedArticlePreview&&(i.relatedArticlePreview.title=null,i.relatedArticlePreview.lead=null,i.relatedArticlePreview.firstImage=" ",i.relatedArticlePreview.contentFields=null),i.showArticlePreview=!1},i.orderChange=function(a,b){i.article.setOrderOfRelatedArticles(a,b).then(function(){g.add({type:"sf-info",message:h.trans("aes.msgs.relatedarticles.order.success")})},function(){g.add({type:"sf-error",message:h.trans("aes.msgs.relatedarticles.order.error")})})},i.loadSearchResults=function(){var a,b,c={},d={};i.articlesSearchResults=[],i.articlesSearchResultsListRetrieved=!1,i.assignedRelatedArticles.forEach(function(a){c[a.articleId]=!0}),b=i.query?i.query.toLowerCase():"",d=i.buildFilters(),i.article.searchArticles(b,d).then(function(b){i.articlesSearchResultsListRetrieved=!0,a=_.filter(b,function(a){return!(a.articleId in c)}),i.articlesSearchResults=a})},i.clearSearch=function(){i.articlesSearchResults=[],i.articlesSearchResultsListRetrieved=!0,i.query=null},i.buildFilters=function(){var a={};return i.publicationFilter&&(a.publication=i.publicationFilter.id),i.issueFilter&&(a.issue=i.issueFilter.number),i.sectionFilter&&(a.section=i.sectionFilter.number),a},i.assignToArticle=function(a){i.assigningRelatedArticles=!0,i.article.addRelatedArticle(a).then(function(b){i.assignedRelatedArticles.push(a),i.loadSearchResults(i.query),g.add({type:"sf-info",message:h.trans("aes.msgs.relatedarticles.pin.success")})},function(){g.add({type:"sf-error",message:h.trans("aes.msgs.relatedarticles.pin.error")})})["finally"](function(){i.assigningRelatedArticles=!1})},i.confirmUnassignRelatedArticle=function(b){var d,e,f;e=h.trans("aes.msgs.relatedarticles.unpin.popupHead"),f=h.trans("aes.msgs.relatedarticles.unpin.popup"),d=c.confirmLight(e,f),d.result.then(function(){return i.article.removeRelatedArticle(b).then(function(){g.add({type:"sf-info",message:h.trans("aes.msgs.relatedarticles.unpin.success")})},function(){g.add({type:"sf-error",message:h.trans("aes.msgs.relatedarticles.unpin.error")})})},a.reject).then(function(){_.remove(i.assignedRelatedArticles,{articleId:b.articleId})})}}]),angular.module("authoringEnvironmentApp").factory("Publication",["$http","$q",function(a,b){var c=function(){};return c.createFromApiData=function(a){var b=new c;return b.name=a.name,b.id=a.id,b},c.getAll=function(){var d,e=[],f=b.defer();return e.$promise=f.promise,d=Routing.generate("newscoop_gimme_publications_getpublications",{},!0),a.get(d).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),e.push(a)}),f.resolve()}).error(function(a){f.reject(a)}),e},c}]),angular.module("authoringEnvironmentApp").factory("Issue",["$http","$q",function(a,b){var c=function(){};return c.createFromApiData=function(a){var b=new c;return b.number=a.number,b.title=a.title,b},c.getAll=function(d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_issues_getissues",d,!0),a.get(e).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},c}]),angular.module("authoringEnvironmentApp").factory("Section",["$http","$q",function(a,b){var c=function(){};return c.createFromApiData=function(a){var b=new c;return b.number=a.number,b.title=a.title,b},c.getAll=function(d){var e,f=[],g=b.defer();return f.$promise=g.promise,e=Routing.generate("newscoop_gimme_sections_getsections",d,!0),a.get(e).success(function(a){a.items.forEach(function(a){a=c.createFromApiData(a),f.push(a)}),g.resolve()}).error(function(a){g.reject(a)}),f},c}]),angular.module("authoringEnvironmentApp").directive("sfAlohaCommandButton",["$rootScope",function(a){var b=['<button class="btn btn-default btn-sm action strong" ','    rel="tooltip" title="{{ ::buttonName }}">','    <i class="editoricon-{{ ::buttonIcon }} ','              fa fa-{{ ::buttonIcon }}"></i>',"</button>"].join("");return{template:b,restrict:"A",replace:!0,scope:{buttonName:"@buttonName",buttonIcon:"@buttonIcon",buttonCommand:"@buttonCommand"},link:function(b,c,d){function e(){c.attr("disabled",!f())}var f,g,h,i;"undo"===b.buttonCommand&&(f=function(){return"function"==typeof Aloha.canUndo?Aloha.canUndo():!1},i="aloha-redo-clicked",h="aloha-undo-clicked",g=function(b){Aloha.undo();var c=Aloha.undoneEditable;c.editable={originalObj:$(Aloha.undoneEditable.originalObj[0].outerHTML)},c.triggerType="undo",a.$emit("texteditor-content-changed",b,c)}),"redo"===b.buttonCommand&&(f=function(){return"function"==typeof Aloha.canRedo?Aloha.canRedo():!1},i="aloha-undo-clicked",h="aloha-redo-clicked",g=function(b){Aloha.redo();var c=Aloha.redoneEditable;c.editable={originalObj:$(Aloha.undoneEditable.originalObj[0].outerHTML)},c.triggerType="undo",a.$emit("texteditor-content-changed",b,c)}),e(),a.$on("texteditor-content-changed",function(){e()}),a.$on(i,function(){e()}),c.bind("click",function(){g(),a.$emit(h),e()})}}}]),angular.module("authoringEnvironmentApp").service("pageHelper",["$rootScope","article","TranslationService",function(a,b,c){var d=this;d.populateHeaderTitle=function(){var d=b.articleInstance;a.headerTitle=c.trans("aes.name")+" - "+d.title}}]),angular.module("authoringEnvironmentApp").controller("EditorialCommentsCtrl",["$scope","$timeout","editorialComments","$interval","TranslationService","toaster",function(a,b,c,d,e,f){var g=20,h=this;h.comments=c,c.init(),h.isLoading=!1,h.create={},h.isSending=!1,h.initComments=function(){h.isLoading=!0,c.init().then(function(){h.isLoading=!1})},h.fetchComments=function(){var b=d(h.initComments,1e3*g);a.$on("$destroy",function(){angular.isDefined(b)&&(d.cancel(b),b=void 0)})},h.cancel=function(a){h.adding=!1,h.create={}},h.add=function(a){h.isSending=!0,c.add(a).then(function(){h.adding=!1,h.isSending=!1,h.create={},f.add({type:"sf-info",message:e.trans("aes.msgs.comments.add.success")})},function(){h.isSending=!1,f.add({type:"sf-error",message:e.trans("aes.msgs.comments.add.error")})})},h.sendReply=function(a){a.sendReply().then(function(){f.add({type:"sf-info",message:e.trans("aes.msgs.comments.reply.success")})},function(){f.add({type:"sf-error",message:e.trans("aes.msgs.comments.reply.error")})})},h.toggleResolved=function(a){a.toggleResolved().then(function(){f.add({type:"sf-info",message:e.trans("aes.msgs.editorialcomments.resolve.success")})},function(){f.add({type:"sf-error",message:e.trans("aes.msgs.editorialcomments.resolve.error")})})},h.saveComment=function(a){a.save().then(function(){f.add({type:"sf-info",message:e.trans("aes.msgs.comments.edit.success")})},function(){f.add({type:"sf-error",message:e.trans("aes.msgs.comments.edit.error")})})}}]),angular.module("authoringEnvironmentApp").directive("editorialComment",function(){return{templateUrl:"views/editorial-comment.html",restrict:"E",scope:{model:"=",allowreplying:"=",onSave:"&saveComment",onReply:"&sendReply",onResolve:"&resolve"},link:function(a,b,c){}}}),angular.module("authoringEnvironmentApp").service("editorialComments",["article","$http","$q","transform","pageTracker","$log",function(a,b,c,d,e,f){function g(){if(n.displayed.length>n.fetched.length)n.displayed=_.difference(n.fetched,n.displayed);else for(var a=0;a<n.fetched.length;a++){for(var b=!1,c=0;c<n.displayed.length;c++)if(n.displayed[c].id===n.fetched[a].id){b=!0;break}b&&n.displayed[a].comment!==n.fetched[a].comment&&(n.displayed[a]=n.fetched[a]),b||n.displayed.splice(a,0,n.fetched[a])}}function h(a){return a.showStatus="collapsed",a.isEdited=!1,a.resolved=!!a.resolved,a.editing={},a.reply={comment:""},a.isReplyMode=!1,a.sendingReply=!1,a.resolving=!1,a.collapse=function(){this.showStatus="collapsed",this.isReplyMode=!1},a.expand=function(){this.showStatus="expanded"},a.toggle=function(){"expanded"===this.showStatus?this.collapse():this.expand()},a.edit=function(){this.editing.comment=this.comment,this.isEdited=!0,this.isReplyMode=!1},a.cancel=function(){this.isEdited=!1},a.save=function(){var a,e=this,f=c.defer();return a=Routing.generate("newscoop_gimme_articles_edit_editorial_comment",{number:k.articleId,language:k.languageData.id,commentId:e.id},!0),b.post(a,{editorial_comment:e.editing},{transformRequest:d.formEncode}).then(function(){f.resolve(),e.comment=e.editing.comment,e.isEdited=!1},function(){f.reject()}),f.promise},a.replyTo=function(){a.isReplyMode=!0},a.cancelReply=function(){a.isReplyMode=!1},a.toggleResolved=function(){var a,e=this,f=c.defer();return a=Routing.generate("newscoop_gimme_articles_edit_editorial_comment",{number:k.articleId,language:k.languageData.id,commentId:e.id},!0),e.resolving=!0,b.post(a,{editorial_comment:{resolved:!0}},{transformRequest:d.formEncode}).then(function(){j(e.id),f.resolve(),e.resolving=!1},function(a){f.reject(a)}),f.promise},a.sendReply=function(){var a,b=this,d=c.defer();return a=angular.copy(b.reply),a.parent=b.id,b.sendingReply=!0,n.add({editorial_comment:a}).then(function(c){i(a.parent,c),b.sendingReply=!1,b.isReplyMode=!1,b.reply={comment:""},d.resolve()},function(){d.reject()}),d.promise},a}function i(a,b){for(var c=0,d=0;d<n.displayed.length;d++)n.displayed[d].parent&&n.displayed[d].parent.id===a&&(c=n.displayed.indexOf(n.displayed[d]));if(c+=1,1===c)for(var e=0;e<n.displayed.length;e++)n.displayed[e].id===a&&(c=n.displayed.indexOf(n.displayed[e])+1);n.displayed.splice(c,0,b)}function j(a){for(var b=[],c=0;c<n.displayed.length;c++)(n.displayed[c].id===a||n.displayed[c].parent&&n.displayed[c].parent.id===a)&&b.push(n.displayed[c]);for(var d=0;d<b.length;d++)n.displayed.splice(n.displayed.indexOf(b[d]),1)}var k=a.articleInstance,l=50,m=1,n=this,o="nested";n.canLoadMore=!0,n.loaded=[],n.fetched=[],n.displayed=[],n.tracker=e.getTracker(),n.init=function(){var a=c.defer();return n.tracker=e.getTracker(),n.loaded=[],n.fetched=[],n.canLoadMore=!0,o="nested",n.getAllByPage(n.tracker.next()).then(function(b){0===n.displayed.length&&(n.displayed=b.items.map(h)),n.fetched=b.items.map(h),g(),a.resolve(),n.canLoadMore&&n.getAllByPage(n.tracker.next()).then(function(a){n.loaded=n.loaded.concat(a.items)})},function(){a.reject()}),a.promise},n.more=function(){if(n.canLoadMore){var a=n.loaded.splice(0,l);a=a.map(h),n.displayed=n.displayed.concat(a);var b=n.tracker.next();m=b,n.getAllByPage(b-1).then(function(a){a.items.length<1&&(n.canLoadMore=!1),n.loaded=n.loaded.concat(a.items)})}else f.error("More comments required, but the service cannot load more of them. In this case the user should not be able to trigger this request")},n.getAllByPage=function(a){var d,e=c.defer(),f=l*m;return l=f,n.displayed.length>0&&(l=f-(f-n.displayed.length)),d=Routing.generate("newscoop_gimme_articles_get_editorial_comments",{language:k.language,number:k.articleId,order:o,items_per_page:l,page:a},!0),b.get(d).then(function(a){var b=a.data;e.resolve(b),(b.items.length<1||void 0===b.pagination)&&(n.canLoadMore=!1)},function(b){n.tracker.remove(a)}),e.promise},n.add=function(a){var e,f=c.defer();return e=Routing.generate("newscoop_gimme_articles_create_editorial_comment",{number:k.articleId,language:k.languageData.id},!0),b.post(e,a,{transformRequest:d.formEncode}).then(function(a){var c=a.headers("x-location");c?b.get(c).then(function(a){var b=a.data;void 0===b.parent&&n.displayed.push(h(b)),f.resolve(h(b))}):n.init()},function(){f.reject()}),f.promise}}]);